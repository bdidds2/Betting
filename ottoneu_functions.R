

library(httr)
library(dplyr)
library(rvest)
library(jsonlite)
library(tidyr)
library(purrr)
library(tidyverse)
library(janitor)
library(htmlwidgets)
library(shiny)
library(reactable)
library(xml2)

library(lubridate)
now <- as_datetime(parse_date_time((now(tz = "EST")), "Ymd HMS", truncated = 3))
refresh_date <- paste0("Refreshed: ", now)

replacements <- c(
  # Lowercase letters
  ñ = "n",
  Ñ = "N",
  á = "a",
  é = "e",
  í = "i",
  ó = "o",
  ú = "u",
  ä = "a",
  ë = "e",
  ï = "i",
  ö = "o",
  ü = "u",
  ý = "y",
  ç = "c",
  ó = "o",  # Replace additional occurrences of ó
  # Uppercase equivalents
  ñ = "N",
  Ñ = "N",
  Á = "A",
  É = "E",
  Í = "I",
  Ó = "O",
  Ú = "U",
  Ä = "A",
  Ë = "E",
  Ï = "I",
  Ö = "O",
  Ü = "U",
  Ý = "Y",
  Ç = "C",
  Ó = "O")


# Function to replace characters
replace_accents <- function(text) {
  # Vectorize replacement using str_replace_all with a named character vector
  replacements_named <- setNames(replacements, names(replacements))
  text <- str_replace_all(text, replacements_named)
  return(text)
}


# players -----------------------------------------------------------------

players_url <- "https://ottoneu.fangraphs.com/averageValues?export=csv"

projection_systems <- c("atc", "zips", "steamer", "thebat", "thebatx")
projection_systems1 <- c("atc", "zips", "steamer", "thebat")

players <- data.frame(read_csv(players_url)) |>
  clean_names() |>
  mutate(avg_salary = as.integer(gsub("\\$", "", avg_salary)),
         fg_major_league_id = as.character(fg_major_league_id),
         median_salary = as.integer(gsub("\\$", "", median_salary)),
         last_10 = as.integer(gsub("\\$", "", last_10)),
         name = replace_accents(name))


# hitter projections and values -------------------------------------------

hitters_df <- data.frame(system = character(),
                         player_name = character(),
                         playerid = character(),
                         ab = numeric(),
                         h = numeric(),
                         hr = numeric(),
                         r = numeric(),
                         rbi = numeric(),
                         sb = numeric())


for (i in projection_systems) {
  hitter_url <- paste0("https://www.fangraphs.com/api/projections?type=", i,"&stats=bat&pos=all&team=0&players=0&lg=all")
  hitters_list <- read_json(hitter_url)
  df <- map_dfr(hitters_list, ~as.data.frame(t(unlist(.)))) |> 
    clean_names() |>
    select(c(player_name, playerid, minpos, team, ab, h, hr, r, rbi, sb)) |>
    mutate_at(c('ab', 'h', 'hr', 'r', 'rbi', 'sb'), as.numeric) |>
    mutate(avg = h / ab,
           system = i)
  hitters_df <- bind_rows(hitters_df, df)
}



hitter_values <- data.frame(player_name = character(),
                            playerid = character(),
                            dollars = double(),
                            system = character())

for (i in projection_systems) {
  hitter_url <- paste0("https://www.fangraphs.com/api/fantasy/auction-calculator/data?teams=12&lg=MLB&dollars=400&mb=1&mp=5&msp=5&mrp=5&type=bat&players=&proj=", i,"&split=&points=c%7C0%2C1%2C2%2C3%2C4%7C0%2C1%2C2%2C3%2C4&rep=0&drp=0&pp=C%2CSS%2C2B%2C3B%2COF%2C1B&pos=1%2C1%2C1%2C1%2C5%2C1%2C1%2C0%2C0%2C1%2C5%2C5%2C0%2C17%2C0&sort=&view=0")
  hitters_list_values <- fromJSON(hitter_url)
  df <- as.data.frame(hitters_list_values$data) |>
    clean_names() |>
    select(c(player_name, playerid, dollars)) |>
    mutate(system = i)
  hitter_values <- bind_rows(hitter_values, df)
}



# pitcher projections and values ------------------------------------------

pitchers_df <- data.frame(system = character(),
                          player_name = character(),
                          playerid = character(),
                          ip = numeric(),
                          w = numeric(),
                          er = numeric(),
                          h = numeric(),
                          bb = numeric(),
                          sv = numeric(),
                          so = numeric(),
                          g = numeric(),
                          gs = numeric())


for (i in projection_systems1) {
  pitcher_url <- paste0("https://www.fangraphs.com/api/projections?type=", i, "&stats=pit&pos=all&team=0&players=0&lg=all")
  pitchers_list <- read_json(pitcher_url)
  df <- map_dfr(pitchers_list, ~as.data.frame(t(unlist(.)))) |> 
    clean_names() |>
    select(c(player_name, playerid, team, ip, w, er, h, bb, sv, so, gs, g)) |>
    mutate_at(c('ip', 'w', 'er', 'h', 'bb', 'sv', 'so', 'gs', 'g'), as.numeric) |>
    mutate(whip = (h+bb) / ip,
           era = (er/ip) * 9,
           system = i)
  pitchers_df <- bind_rows(pitchers_df, df)
}


pitcher_values <- data.frame(player_name = character(),
                             playerid = character(),
                             dollars = double(),
                             system = character())

for (i in projection_systems) {
  pitcher_url <- paste0("https://www.fangraphs.com/api/fantasy/auction-calculator/data?teams=12&lg=MLB&dollars=400&mb=1&mp=5&msp=5&mrp=5&type=pit&players=&proj=", i,"&split=&points=c%7C0%2C1%2C2%2C3%2C4%7C0%2C1%2C2%2C3%2C4&rep=0&drp=0&pp=C%2CSS%2C2B%2C3B%2COF%2C1B&pos=1%2C1%2C1%2C1%2C5%2C1%2C1%2C0%2C0%2C1%2C5%2C5%2C0%2C17%2C0&sort=&view=0")
  pitchers_list_values <- fromJSON(pitcher_url)
  df <- as.data.frame(pitchers_list_values$data) |>
    clean_names() |>
    select(c(player_name, playerid, dollars)) |>
    mutate(system = i)
  pitcher_values <- bind_rows(pitcher_values, df)
}



# get player info ---------------------------------------------------------

hitters_each_system <- left_join(hitters_df, hitter_values |> select(c(playerid, system, dollars)), 
                     by = c("playerid"="playerid", "system" = "system")) |>
  left_join(players |> select(fg_major_league_id, avg_salary, last_10, roster, position_s), 
            by = c("playerid" = "fg_major_league_id")) |>
  rename("position" = "position_s") |>
  select(-minpos) |>
  mutate(hr_per600 = (600/ab)*hr,
         r_per600 = (600/ab)*r,
         rbi_per600 = (600/ab)*rbi,
         sb_per600 = (600/ab)*sb,
         player_name = replace_accents(player_name))

hitters_agg <- hitters_each_system %>%
  group_by(player_name, playerid, team, position) %>%
  summarize(dollars_mean = round(mean(dollars), 0),
            dollars_max = round(max(dollars), 0),
            dollars_min = round(min(dollars), 0),
            dollars_sd = round(sd(dollars), 1),
            ab_mean = round(mean(ab), 0),
            h_mean = mean(h),
            hr_mean = round(mean(hr), 0),
            r_mean = round(mean(r), 0),
            rbi_mean = round(mean(rbi), 0),
            sb_mean = round(mean(sb), 0),
            avg_mean = round(h_mean / ab_mean, 3),
            hr_per_600_mean = round(mean(hr_per600), 1),
            r_per_600_mean = round(mean(r_per600), 1),
            rbi_per_600_mean = round(mean(rbi_per600), 1),
            sb_per_600_mean = round(mean(sb_per600), 1)) %>%
  ungroup() %>%
  arrange(desc(dollars_mean)) %>%
  head(400) %>%
  select(-c(h_mean))

pitchers_each_system <- left_join(pitchers_df, pitcher_values |> select(c(playerid, system, dollars)), 
                      by = c("playerid"="playerid", "system" = "system")) |>
  left_join(players |> select(fg_major_league_id, avg_salary, last_10, roster), 
            by = c("playerid" = "fg_major_league_id")) |>
  mutate(position = case_when(gs / g > .5 ~ "SP",
                              TRUE ~ "RP")) |>
  group_by(playerid) |>
  mutate(gs_perc = sum(gs) / sum(g)) |>
  ungroup() |>
  select(-c(gs_perc)) 

pitchers_agg <- pitchers_each_system %>%
  group_by(player_name, playerid, team, position) %>%
  summarize(dollars_mean = round(mean(dollars), 0),
            dollars_max = round(max(dollars), 0),
            dollars_min = round(min(dollars), 0),
            dollars_sd = round(sd(dollars), 1),
            ip_mean = round(mean(ip), 0),
            w_mean = round(mean(w), 0),
            sv_mean = round(mean(sv), 0),
            k_mean = round(mean(so), 0),
            er_mean = mean(er),
            bb_mean = mean(bb),
            h_mean = mean(h),
            era_mean = round(er_mean*9/ip_mean, 2),
            whip_mean = round((bb_mean + h_mean) / ip_mean, 2),
            k_9 = round(k_mean / ip_mean * 9, 1),
            k_bb = round(k_9 - (bb_mean / ip_mean * 9), 1)) %>%
  ungroup() %>%
  arrange(desc(dollars_mean)) %>%
  head(400) %>%
  select(-c(bb_mean, h_mean))

# get rosters -------------------------------------------------------------


get_rosters <- function(league_number) {
  rosters_url <- paste0("https://ottoneu.fangraphs.com/", as.character(league_number), "/rosterexport?csv=1")
  rosters <- data.frame(read_csv(rosters_url)) |>
    clean_names() |>
    mutate(salary = as.integer(gsub("\\$", "", salary)),
           fg_major_league_id = as.character(fg_major_league_id)) |>
    rowwise() |>
    mutate(name = replace_accents(name)) |>
    ungroup()
  return(rosters)
}


# get full player dfs -----------------------------------------------------


get_hitters <- function(roster_input = rosters) {
  hitters <- left_join(hitters_df, hitter_values |> select(c(playerid, system, dollars)), 
                       by = c("playerid"="playerid", "system" = "system")) |>
    left_join(roster_input |> select(c(fg_major_league_id, team_name, salary)), 
              by = c("playerid" = "fg_major_league_id")) |>
    mutate(team_name = ifelse(is.na(team_name), "Free Agent", team_name),
           value = dollars - salary) |>
    left_join(players |> select(fg_major_league_id, avg_salary, last_10, roster, position_s), 
              by = c("playerid" = "fg_major_league_id")) |>
    rename("position" = "position_s") |>
    select(-minpos) |>
    mutate(hr_per600 = (600/ab)*hr,
           r_per600 = (600/ab)*r,
           rbi_per600 = (600/ab)*rbi,
           sb_per600 = (600/ab)*sb) |>
    mutate(team_name = trimws(gsub("[^a-zA-Z ]", "", team_name))) 
  return(hitters)
}


get_pitchers <- function(roster_input = rosters) {
  pitchers <- left_join(pitchers_df, pitcher_values |> select(c(playerid, system, dollars)), 
                        by = c("playerid"="playerid", "system" = "system")) |>
    left_join(roster_input |> select(c(fg_major_league_id, team_name, salary)), 
              by = c("playerid" = "fg_major_league_id")) |>
    mutate(team_name = ifelse(is.na(team_name), "Free Agent", team_name),
           value = dollars - salary) |>
    left_join(players |> select(fg_major_league_id, avg_salary, last_10, roster), 
              by = c("playerid" = "fg_major_league_id")) |>
    mutate(position = case_when(gs / g > .5 ~ "SP",
                                TRUE ~ "RP")) |>
    group_by(playerid) |>
    mutate(gs_perc = sum(gs) / sum(g)) |>
    ungroup() |>
    mutate(position = ifelse(gs_perc > .5, "SP", "RP"),
           dollars = ifelse(is.na(dollars), 0, dollars),
           value = ifelse(is.na(value), 0, value)) |>
    select(-c(gs_perc)) |>
    mutate(team_name = trimws(gsub("[^a-zA-Z ]", "", team_name))) 
  return(pitchers)
}



# get transformed rostered players ----------------------------------------


get_rostered_hitters <- function(roster_input = rosters) {
  hitters <- get_hitters(roster_input)
  hitters_rostered <- hitters |>
    filter(team_name != "Free Agent") |>
    mutate(position_group = case_when(grepl("C", position) ~ "C",
                                      position == "OF" ~ "OF",
                                      position == "2B" ~ "MI",
                                      position == "SS" ~ "MI",
                                      position == "3B" ~ "3B",
                                      position == "1B" ~ "1B",
                                      position == "UT" ~ "UT",
                                      grepl("C", position) ~ "C",
                                      grepl("2B", position) ~ "MI",
                                      grepl("SS", position) ~ "MI",
                                      grepl("3B", position) ~ "3B",
                                      grepl("1B", position) ~ "1B",
                                      TRUE ~ position)) |>
    group_by(team_name, player_name, position_group) |>
    summarize(dollars_avg = mean(dollars)) |>
    group_by(team_name, position_group) |>
    mutate(position_group_rank = rank(-dollars_avg)) |>
    ungroup() |>
    select(c(player_name, dollars_avg, position_group, position_group_rank)) |>
    left_join(hitters, by = "player_name") |>
    mutate(position_roup_rank = paste0(position_group, position_group_rank),
           starting = case_when(position_group == "C" & position_group_rank == 1 ~ 1,
                                position_group == "1B" & position_group_rank <= 1 ~ 1,
                                position_group == "3B" & position_group_rank <= 1 ~ 1,
                                position_group == "MI" & position_group_rank <= 3 ~ 1,
                                position_group == "OF" & position_group_rank <= 5 ~ 1,
                                position_group == "DH" & position_group_rank == 1 ~ 1,
                                TRUE ~ 0)) |>
    group_by(team_name, starting) |>
    mutate(starting2 = ifelse(starting == 0 & dollars_avg == max(dollars_avg), 1, 0)) |>
    ungroup() |>
    mutate(starting = case_when(starting == 1 ~ 1,
                                starting2 == 1 ~ 1, 
                                TRUE ~ 0)) |>
    select(-c(starting2))
  return(hitters_rostered)
}

get_rostered_pitchers <- function(roster_input = rosters) {
  pitchers <- get_pitchers(roster_input)
  pitchers_rostered <- pitchers |>
    filter(team_name != "Free Agent") |>
    group_by(team_name, player_name, playerid, position) |>
    summarize(dollars_avg = mean(dollars)) |>
    group_by(team_name, position) |>
    mutate(position_rank = rank(-dollars_avg)) |>
    ungroup() |>
    select(c(player_name, dollars_avg, position_rank)) |>
    left_join(pitchers, by = "player_name", relationship = "many-to-many") |>
    mutate(position_and_rank = paste0(position, position_rank),
           starting = ifelse(position_rank <= 5, 1, 0))
  return(pitchers_rostered)
}



# get free agents ---------------------------------------------------------

get_fa_hitters <- function(roster_input = rosters) {
  hitters <- get_hitters(roster_input)
  hitters_fa <- hitters |>
    filter(team_name == "Free Agent") |>
    mutate(position_group = case_when(grepl("C", position) ~ "C",
                                      position == "OF" ~ "OF",
                                      position == "2B" ~ "MI",
                                      position == "SS" ~ "MI",
                                      position == "3B" ~ "3B",
                                      position == "1B" ~ "1B",
                                      position == "UT" ~ "UT",
                                      grepl("C", position) ~ "C",
                                      grepl("2B", position) ~ "MI",
                                      grepl("SS", position) ~ "MI",
                                      grepl("3B", position) ~ "3B",
                                      grepl("1B", position) ~ "1B",
                                      TRUE ~ position)) |>
    group_by(position_group, playerid) |>
    summarize(dollars_avg = mean(dollars, na.rm = TRUE)) |>
    group_by(position_group) |>
    mutate(position_group_rank = rank(-dollars_avg)) |>
    ungroup() |>
    select(c(playerid, dollars_avg, position_group, position_group_rank)) |>
    left_join(hitters, by = "playerid", relationship = "many-to-many") |>
    mutate(position_roup_rank = paste0(position_group, position_group_rank),
           starting = case_when(position_group == "C" & position_group_rank == 1 ~ 1,
                                position_group == "1B" & position_group_rank <= 1 ~ 1,
                                position_group == "3B" & position_group_rank <= 1 ~ 1,
                                position_group == "MI" & position_group_rank <= 3 ~ 1,
                                position_group == "OF" & position_group_rank <= 5 ~ 1,
                                position_group == "DH" & position_group_rank == 1 ~ 1,
                                TRUE ~ 0)) |>
    group_by(player_name, playerid, position_group, position_group_rank, position) |>
    summarize(ab = mean(ab),
              h = mean(h),
              hr = mean(hr),
              r = mean(r),
              rbi = mean(rbi),
              sb = mean(sb),
              dollars = mean(dollars_avg)) |>
    ungroup() |>
    mutate(avg = h / ab) |>
    arrange(desc(dollars)) |>
    rowwise() %>%
    mutate(
      catcher = ifelse(grepl("C", position), "C", ""),
      first = ifelse(grepl("1B", position), "1B", ""),
      third = ifelse(grepl("3B", position), "3B", ""),
      second = ifelse(grepl("2B", position), "MI", ""),
      shortstop = ifelse(grepl("SS", position), "MI", ""),
      outfield = ifelse(grepl("OF", position), "OF", ""),
      ut = ifelse(grepl("UT", position), "UT", ""),
      position_group2 = trimws(paste(
        catcher, first, second, shortstop, third, outfield, ut,
        collapse = "/"
      ))
    ) |>
    ungroup() |>
    mutate(position_group2 = trimws(gsub(" ", "/", position_group2)),
           position_group2 = gsub("///", "/", position_group2),
           position_group2 = gsub("//", "/", position_group2),
           position_group2 = gsub("//", "/", position_group2),
           position_group2 = gsub("//", "/", position_group2),
           position_group2 = gsub("MI/MI", "MI", position_group2),
           position_group2 = gsub("CI/CI", "CI", position_group2),
           position_group = position_group2) |>
    select(-c(catcher, first, third, shortstop, second, outfield, ut, position_group2)) |>
    select(c(player_name, position_group, position_group_rank, position, dollars, h, hr, r, rbi, sb, avg, ab)) |>
    mutate(hr_rate = hr / ab,
           r_rate = r/ab,
           rbi_rate = rbi/ab,
           sb_rate = sb/ab)
  return(hitters_fa)
}

get_fa_pitchers <- function(roster_input = rosters) {
  pitchers <- get_pitchers(roster_input)
  pitchers_fa <- pitchers |>
    filter(team_name == "Free Agent") |>
    group_by(position, playerid) |>
    summarize(dollars_avg = mean(dollars, na.rm = TRUE)) |>
    ungroup() |>
    mutate(position_rank = rank(-dollars_avg)) |>
    ungroup() |>
    select(c(playerid, dollars_avg, position, position_rank)) |>
    left_join(pitchers |> select(-c(position)), by = "playerid", relationship = "many-to-many") |>
    mutate(position_rank = paste0(position, position_rank)) |>
    group_by(player_name, playerid, position, position_rank) |>
    summarize(ip = mean(ip),
              w = mean(w),
              er = mean(er),
              h = mean(h),
              bb = mean(bb),
              sv = mean(sv),
              so = mean(so),
              dollars = mean(dollars_avg, na.rm = TRUE)) |>
    ungroup() |>
    mutate(whip = (h+bb) / ip,
           era = (er/ip) * 9,
           k_9 = so / (ip/9),
           bb_9 = bb / (ip/9),
           k_bb = so/bb) |>
    arrange(desc(dollars))
  return(pitchers_fa)
}


# get league projections --------------------------------------------------

recent_league_standings_url <- "https://ottoneu.fangraphs.com/1275/standings?date=2023-10-01"

recent_league_standings <- as.data.frame(html_table(read_html(recent_league_standings_url))[2]) |>
  clean_names() |>
  select(-team) |>
  head(11)

recent_league_standings_function <- function(category, number) {
  column_index <- which(colnames(recent_league_standings) == category)
  category_performance <- recent_league_standings[, column_index]
  added_number <- number
  modified_category_performance <- append(category_performance, added_number)
  added_number_points <- rank(modified_category_performance, ties.method = "min")[length(modified_category_performance)]
  added_number_points_oppo <- rank(-modified_category_performance, ties.method = "min")[length(modified_category_performance)]
  added_number_points_final <- ifelse(category == "whip", added_number_points_oppo,
                                      ifelse(category == "era", added_number_points_oppo,
                                      added_number_points))
  return(added_number_points_final)
}

get_scenarios_hitters <- function(roster_input = rosters) {
  iterations <- 10
  league_scenarios_hitters_df <- get_rostered_hitters(roster_input) |>
    filter(starting == 1, team_name != "Free Agent") |>
    group_by(team_name, player_name, playerid) |>
    reframe(ab = (rnorm(n = iterations, mean = mean(ab, na.rm = TRUE), sd = sd(ab, na.rm = TRUE))),
            h = (rnorm(n = iterations, mean = mean(h, na.rm = TRUE), sd = sd(h, na.rm = TRUE))),
            hr = (rnorm(n = iterations, mean = mean(hr, na.rm = TRUE), sd = sd(hr, na.rm = TRUE))),
            r = (rnorm(n = iterations, mean = mean(r, na.rm = TRUE), sd = sd(r, na.rm = TRUE))),
            rbi = (rnorm(n = iterations, mean = mean(rbi, na.rm = TRUE), sd = sd(rbi, na.rm = TRUE))),
            sb = (rnorm(n = iterations, mean = mean(sb, na.rm = TRUE), sd = sd(sb, na.rm = TRUE))),
            avg = h / ab,
            dollars = (rnorm(n = iterations, mean = mean(dollars, na.rm = TRUE), sd = sd(dollars, na.rm = TRUE))),
            value = (rnorm(n = iterations, mean = mean(value, na.rm = TRUE), sd = sd(value, na.rm = TRUE))),
            index = row_number(dollars)) |>
    ungroup() |>
    group_by(team_name, index) |>
    summarize(ab = sum(ab),
              h = sum(h),
              hr = sum(hr),
              r = sum(r),
              rbi = sum(rbi),
              sb = sum(sb),
              avg = h / ab,
              value = sum(value, na.rm = TRUE),
              r_rank_history = recent_league_standings_function("r", r),
              rbi_rank_history = recent_league_standings_function("rbi", rbi),
              hr_rank_history = recent_league_standings_function("hr", hr),
              sb_rank_history = recent_league_standings_function("sb", sb),
              avg_rank_history = recent_league_standings_function("avg", avg)) |>
    ungroup() |>
    group_by(index) |>
    mutate(r_rank = rank(r),
           rbi_rank = rank(rbi),
           hr_rank = rank(hr),
           sb_rank = rank(sb),
           avg_rank = rank(avg),
           hitting_points = r_rank + rbi_rank + hr_rank + sb_rank + avg_rank,
           hitting_points_history = r_rank_history + rbi_rank_history + hr_rank_history + sb_rank_history + avg_rank_history,
           #avg_to_target = avg - hitting_targets$avg,
           #hr_to_target = hr - hitting_targets$hr,
           #r_to_target = r - hitting_targets$r,
           #rbi_to_target = rbi - hitting_targets$rbi,
           #sb_to_target = sb - hitting_targets$sb,
           combined_rank = rank(desc(hitting_points)),
           combined_rank_history = rank(desc(hitting_points_history))) |>
    # Identify top 3 using indexing
    mutate(
      first_place = combined_rank %in% c(1, 1.5),
      second_place = combined_rank %in% c(2, 2.5),
      third_place = combined_rank %in% c(3, 3.5),
      first_place_history = combined_rank_history %in% c(1, 1.5),
      second_place_history = combined_rank_history %in% c(2, 2.5),
      third_place_history = combined_rank_history %in% c(3, 3.5)) |>
    ungroup() |>
    group_by(team_name) |>
    summarize(ab = mean(ab),
              h = mean(h),
              hr = mean(hr),
              r = mean(r),
              rbi = mean(rbi),
              sb = mean(sb),
              avg = mean(avg),
              value = mean(value),
              r_rank = mean(r_rank),
              rbi_rank = mean(rbi_rank),
              hr_rank = mean(hr_rank),
              sb_rank = mean(sb_rank),
              avg_rank = mean(avg_rank),
              hitting_points = mean(hitting_points),
              first_place = sum(first_place) / iterations,
              second_place = sum(second_place) / iterations,
              third_place = sum(third_place) / iterations,
              r_rank_history = mean(r_rank_history),
              rbi_rank_history = mean(rbi_rank_history),
              hr_rank_history = mean(hr_rank_history),
              sb_rank_history = mean(sb_rank_history),
              avg_rank_history = mean(avg_rank_history),
              hitting_points_history = mean(hitting_points_history),
              first_place_history = sum(first_place_history) / iterations,
              second_place_history = sum(second_place_history) / iterations,
              third_place_history = sum(third_place_history) / iterations) |>
    ungroup()
  return(league_scenarios_hitters_df)
}

get_scenarios_hitters2 <- function(roster_input = rosters) {
  iterations <- 1
  league_scenarios_hitters_df <- get_rostered_hitters(roster_input) |>
    filter(starting == 1, team_name != "Free Agent") |>
    group_by(team_name, player_name, playerid) |>
    reframe(#ab = (Rnorm(n = iterations, m = mean(ab, na.rm = TRUE), s = sd(ab, na.rm = TRUE))),
            #h = (Rnorm(n = iterations, m = mean(h, na.rm = TRUE), s = sd(h, na.rm = TRUE))),
            #hr = (Rnorm(n = iterations, m = mean(hr, na.rm = TRUE), s = sd(hr, na.rm = TRUE))),
            #r = (Rnorm(n = iterations, m = mean(r, na.rm = TRUE), s = sd(r, na.rm = TRUE))),
            #rbi = (Rnorm(n = iterations, m = mean(rbi, na.rm = TRUE), s = sd(rbi, na.rm = TRUE))),
            #sb = (Rnorm(n = iterations, m = mean(sb, na.rm = TRUE), s = sd(sb, na.rm = TRUE))),
            #avg = h / ab,
            #dollars = (Rnorm(n = iterations, m = mean(dollars, na.rm = TRUE), s = sd(dollars, na.rm = TRUE))),
            #value = (Rnorm(n = iterations, m = mean(value, na.rm = TRUE), s = sd(value, na.rm = TRUE))),
            #index = row_number(dollars)) |>
            ab = mean(ab, na.rm = TRUE),
            h = mean(h, na.rm = TRUE),
            hr = mean(hr, na.rm = TRUE),
            r = mean(r, na.rm = TRUE),
            rbi = mean(rbi, na.rm = TRUE),
            sb = mean(sb, na.rm = TRUE),
            avg = h / ab,
            dollars = mean(dollars, na.rm = TRUE),
            value = mean(value, na.rm = TRUE),
            index = row_number(dollars)) |>
    ungroup() |>
    group_by(team_name, index) |>
    summarize(ab = sum(ab),
              h = sum(h),
              hr = sum(hr),
              r = sum(r),
              rbi = sum(rbi),
              sb = sum(sb),
              avg = h / ab,
              value = sum(value, na.rm = TRUE),
              r_rank_history = recent_league_standings_function("r", r),
              rbi_rank_history = recent_league_standings_function("rbi", rbi),
              hr_rank_history = recent_league_standings_function("hr", hr),
              sb_rank_history = recent_league_standings_function("sb", sb),
              avg_rank_history = recent_league_standings_function("avg", avg)) |>
    ungroup() |>
    group_by(index) |>
    mutate(r_rank = rank(r),
           rbi_rank = rank(rbi),
           hr_rank = rank(hr),
           sb_rank = rank(sb),
           avg_rank = rank(avg),
           hitting_points = r_rank + rbi_rank + hr_rank + sb_rank + avg_rank,
           hitting_points_history = r_rank_history + rbi_rank_history + hr_rank_history + sb_rank_history + avg_rank_history,
           #avg_to_target = avg - hitting_targets$avg,
           #hr_to_target = hr - hitting_targets$hr,
           #r_to_target = r - hitting_targets$r,
           #rbi_to_target = rbi - hitting_targets$rbi,
           #sb_to_target = sb - hitting_targets$sb,
           combined_rank = rank(desc(hitting_points)),
           combined_rank_history = rank(desc(hitting_points_history))) |>
    # Identify top 3 using indexing
    mutate(
      first_place = combined_rank %in% c(1, 1.5),
      second_place = combined_rank %in% c(2, 2.5),
      third_place = combined_rank %in% c(3, 3.5),
      first_place_history = combined_rank_history %in% c(1, 1.5),
      second_place_history = combined_rank_history %in% c(2, 2.5),
      third_place_history = combined_rank_history %in% c(3, 3.5)) |>
    ungroup() |>
    group_by(team_name) |>
    summarize(ab = mean(ab),
              h = mean(h),
              hr = mean(hr),
              r = mean(r),
              rbi = mean(rbi),
              sb = mean(sb),
              avg = mean(avg),
              value = mean(value),
              r_rank = mean(r_rank),
              rbi_rank = mean(rbi_rank),
              hr_rank = mean(hr_rank),
              sb_rank = mean(sb_rank),
              avg_rank = mean(avg_rank),
              hitting_points = mean(hitting_points),
              first_place = sum(first_place) / iterations,
              second_place = sum(second_place) / iterations,
              third_place = sum(third_place) / iterations,
              r_rank_history = mean(r_rank_history),
              rbi_rank_history = mean(rbi_rank_history),
              hr_rank_history = mean(hr_rank_history),
              sb_rank_history = mean(sb_rank_history),
              avg_rank_history = mean(avg_rank_history),
              hitting_points_history = mean(hitting_points_history),
              first_place_history = sum(first_place_history) / iterations,
              second_place_history = sum(second_place_history) / iterations,
              third_place_history = sum(third_place_history) / iterations) |>
    ungroup()
  return(league_scenarios_hitters_df)
}



get_scenarios_pitchers <- function(roster_input = rosters) {
  league_scenarios_pitchers_df <- get_rostered_pitchers(roster_input) |>
    filter(starting == 1, team_name != "Free Agent") |>
    group_by(team_name, player_name, playerid) |>
    reframe(ip = mean(ip, na.rm = TRUE),
            w = mean(w, na.rm = TRUE),
            er = mean(er, na.rm = TRUE),
            h = mean(h, na.rm = TRUE),
            bb = mean(bb, na.rm = TRUE),
            sv = mean(sv, na.rm = TRUE),
            so = mean(so, na.rm = TRUE),
            whip = (h+bb) / ip,
            era = (er/ip) * 9,
            k_9 = so / (ip / 9),
            k_bb = so/bb,
            dollars = mean(dollars, na.rm = TRUE),
            value = mean(value, na.rm = TRUE),
            index = row_number(dollars)) |>
    ungroup() |>
    group_by(team_name, index) |>
    summarize(ip = sum(ip),
              w = sum(w),
              er = sum(er),
              h = sum(h),
              bb = sum(bb),
              sv = sum(sv),
              so = sum(so),
              whip = (h+bb) / ip,
              era = (er/ip) * 9,
              k_9 = so / (ip / 9),
              k_bb = so/bb,
              value = sum(value, na.rm = TRUE),
              w_rank_history = recent_league_standings_function("wins", w),
              sv_rank_history = recent_league_standings_function("sv", sv),
              so_rank_history = recent_league_standings_function("k", so),
              whip_rank_history = recent_league_standings_function("whip", whip),
              era_rank_history = recent_league_standings_function("era", era)) |>
    ungroup() |>
    group_by(index) |>
    mutate(w_rank = rank(w),
           sv_rank = rank(sv),
           so_rank = rank(so),
           whip_rank = rank(whip),
           era_rank = rank(era),
           pitching_points = w_rank + sv_rank + so_rank + whip_rank + era_rank,
           pitching_points_history = w_rank_history + sv_rank_history + so_rank_history + whip_rank_history + era_rank_history,
           combined_rank = rank(desc(pitching_points)),
           combined_rank_history = rank(desc(pitching_points_history))) |>
    # Identify top 3 using indexing
    mutate(
      first_place = combined_rank == c(1, 1.5),
      second_place = combined_rank %in% c(2, 2.5),
      third_place = combined_rank %in% c(3, 3.5),
      first_place_history = combined_rank_history %in% c(1, 1.5),
      second_place_history = combined_rank_history %in% c(2, 2.5),
      third_place_history = combined_rank_history %in% c(3, 3.5)) |>
    ungroup() |>
    group_by(team_name) |>
    summarize(ip = mean(ip),
              w = mean(w),
              sv = mean(sv),
              so = mean(so),
              whip = mean(whip),
              era = mean(era),
              h = mean(h),
              bb = mean(bb),
              value = mean(value),
              w_rank = mean(w_rank),
              sv_rank = mean(sv_rank),
              so_rank = mean(so_rank),
              whip_rank = mean(whip_rank),
              era_rank = mean(era_rank),
              pitching_points = mean(pitching_points),
              first_place = sum(first_place),
              second_place = sum(second_place),
              third_place = sum(third_place),
              w_rank_history = mean(w_rank_history),
              sv_rank_history = mean(sv_rank_history),
              so_rank_history = mean(so_rank_history),
              whip_rank_history = mean(whip_rank_history),
              era_rank_history = mean(era_rank_history),
              pitching_points_history = mean(pitching_points_history),
              first_place_history = sum(first_place_history),
              second_place_history = sum(second_place_history),
              third_place_history = sum(third_place_history)) |>
    ungroup()
  return(league_scenarios_pitchers_df)
}

# add hitter functions

change_df_original <- data.frame(player = character(),
                                 playerid = character(),
                                 hitting_point_change = numeric(),
                                 first_place_change = numeric(),
                                 second_place_change = numeric(),
                                 third_place_change = numeric())



add_hitter <- function(roster_input = rosters, ottoneu_team, new_player) {
  rosters <- roster_input
  original <- get_scenarios_hitters2(roster_input) |> 
    filter(team_name == ottoneu_team) |> 
    select(c(team_name, hitting_points, first_place, second_place, third_place, hitting_points_history))
  for(i in new_player) {
    i <- replace_accents(i)
    roster_check <- rosters |> filter(name == i) |> arrange(desc(salary)) |> head(1) |> nrow()
    new_roster_one <- rosters |> mutate(team_name = ifelse(name == i, ottoneu_team, team_name))
    new_roster_two <- rosters |> add_row(team_id = rosters |> filter(team_name == ottoneu_team) |> head(1) |> pull(team_id),
                                         team_name = ottoneu_team,
                                         fg_major_league_id = players |> filter(name == i) |> arrange(desc(avg_salary)) |> head(1) |> pull(fg_major_league_id),
                                         fg_minor_league_id = players |> filter(name == i) |> arrange(desc(avg_salary)) |> head(1) |> pull(fg_minor_league_id),
                                         name = i,
                                         mlb_team = players |> filter(name == i) |> arrange(desc(avg_salary)) |> head(1) |> pull(mlb_org),
                                         position_s = players |> filter(name == i) |> arrange(desc(avg_salary)) |> head(1) |> pull(position_s),
                                         salary = players |> filter(name == i) |> arrange(desc(avg_salary)) |> head(1) |> pull(last_10))
    added_hitter <- case_when(roster_check == 1 ~ list(new_roster_one), 
                              TRUE ~ list(new_roster_two))
    added_hitter <- added_hitter[[1]]
    
    rosters_new <- added_hitter
    
    updated <- get_scenarios_hitters2(rosters_new) |> 
      filter(team_name == ottoneu_team) |> 
      select(c(team_name, hitting_points, first_place, second_place, third_place, hitting_points_history))
    change_df <- data.frame(player = i,
                            playerid = players |> filter(name == i) |> arrange(desc(avg_salary)) |> head(1) |> pull(fg_major_league_id),
                            hitting_point_change = updated$hitting_points - original$hitting_points,
                            first_place_change = updated$first_place - original$first_place,
                            second_place_change = updated$second_place - original$second_place,
                            third_place_change = updated$third_place - original$third_place,
                            hitting_point_change_history = updated$hitting_points_history - original$hitting_points_history)
    change_df_original <- bind_rows(change_df_original, change_df)
  }
  return(change_df_original)
}


get_top_fa_hitters <- function(league_number, ottoneu_team, number = 10) {
  top_fa_hitters <- get_fa_hitters(get_rosters(league_number)) |> 
    head(number) |> 
    filter(!is.na(position)) |> 
    rowwise() |> 
    mutate(hitting_point_change = add_hitter(get_rosters(league_number), ottoneu_team, player_name) |> 
             pull(hitting_point_change),
           hitting_point_change_history = add_hitter(get_rosters(league_number), ottoneu_team, player_name) |> 
             pull(hitting_point_change_history))
  return(top_fa_hitters)
}

get_top_fa_hitters2 <- function(league_number, ottoneu_team, position_group_input = "All", number = 10) {
  rosters <- get_rosters(league_number)
  top_fa_hitters <- get_fa_hitters(rosters) |> 
    filter(if (position_group_input != "All") grepl(position_group_input, position_group) else TRUE) |>
    head(number) |> 
    filter(!is.na(position)) |> 
    rowwise() |> 
    mutate(hitting_point_change = add_hitter(rosters, ottoneu_team, player_name) |> 
             pull(hitting_point_change),
           hitting_point_change_history = add_hitter(rosters, ottoneu_team, player_name) |> 
             pull(hitting_point_change_history),
           dollars_per_spg = ifelse(hitting_point_change == 0, 0, dollars / hitting_point_change),
           dollars_per_spg_py = ifelse(hitting_point_change_history == 0, 0, dollars / hitting_point_change_history))
  return(top_fa_hitters)
}

top_fa_hitters_reactable <- function(league_number, ottoneu_team, position_group_input = "All", number = 20) {
  #ottoneu_teams <- as.data.frame(html_table(read_html(paste0("https://ottoneu.fangraphs.com/", league_number, "/standings")))[1]) |> select(Team) |> mutate(Team = trimws(gsub("[^a-zA-Z ]", "", Team))) |> as.vector()
  top_fa_hitters <- get_top_fa_hitters2(league_number, ottoneu_team, position_group_input, number) |>
    select(c(player_name, position, dollars, hitting_point_change, dollars_per_spg, hitting_point_change_history, dollars_per_spg_py, hr, r, rbi, sb, avg)) |>
    arrange(desc(hitting_point_change))
  coloring <- function(x) {
    x <- x[!is.na(x)]
    rgb(colorRamp(c("red", "white", "green"))(x), maxColorValue = 255)
  }
  coloring_opp <- function(x) {
    x <- x[!is.na(x)]
    rgb(colorRamp(c("red", "white", "green"))(x), maxColorValue = 255)
  }
  
  reactable <- reactable(
    top_fa_hitters,
    columns = list(
      player_name = colDef(name = "Player", width = 150, filterable = TRUE),
      position = colDef(name = "Position", width = 75, filterable = TRUE),
      hitting_point_change = colDef(name = "SPG Current", width = 80, format = colFormat(digits = 1),
                                    style = function(value) {
                                      normalized <- (value - min(top_fa_hitters$hitting_point_change)) / (max(top_fa_hitters$hitting_point_change) - min(top_fa_hitters$hitting_point_change))
                                      color <- coloring(normalized)
                                      list(background = color)
                                    }),
      hitting_point_change_history = colDef(name = "SPG Prior Year", width = 80, format = colFormat(digits = 1),
                                            style = function(value) {
                                              normalized <- (value - min(top_fa_hitters$hitting_point_change_history)) / (max(top_fa_hitters$hitting_point_change_history) - min(top_fa_hitters$hitting_point_change_history))
                                              color <- coloring(normalized)
                                              list(background = color)
                                            }),
      dollars = colDef(name = "$$", width = 65,
                       style = function(value) {
                         normalized <- (value - min(top_fa_hitters$dollars)) / (max(top_fa_hitters$dollars) - min(top_fa_hitters$dollars))
                         color <- coloring(normalized)
                         list(background = color)
                       }),
      dollars_per_spg = colDef(name = "$$/SPG", width = 70, format = colFormat(digits = 1)),
      dollars_per_spg_py = colDef(name = "$$/SPG PY", width = 70, format = colFormat(digits = 1)),
      hr = colDef(name = "HR", width = 50),
      r = colDef(name = "R", width = 50),
      rbi = colDef(name = "RBI", width = 50),
      sb = colDef(name = "SB", width = 50),
      avg = colDef(name = "Avg.", format = colFormat(digits = 3), width = 50)),
    defaultColDef = colDef(
      header = function(value) gsub(".", " ", value, fixed = TRUE),
      #cell = function(value) format(value, nsmall = 1),
      #align = "center",
      #wit = 200,
      headerStyle = list(background = "#f7f7f8"),
      format = colFormat(digits = 0)),
    bordered = TRUE,
    highlight = TRUE,
    defaultPageSize = 20)
  
  return(reactable)
}



# add pitcher function

change_df_original_pitcher <- data.frame(player = character(),
                                         playerid = character(),
                                         pitching_point_change = numeric(),
                                         first_place_change = numeric(),
                                         second_place_change = numeric(),
                                         third_place_change = numeric())



add_pitcher <- function(roster_input = rosters, ottoneu_team, new_player) {
  rosters <- roster_input
  original <- get_scenarios_pitchers(roster_input) |> 
    filter(team_name == ottoneu_team) |> 
    select(c(team_name, pitching_points, first_place, second_place, third_place, pitching_points_history))
  for(i in new_player) {
    i <- replace_accents(i)
    roster_check <- rosters |> filter(name == i) |> arrange(desc(salary)) |> head(1) |> nrow()
    new_roster_one <- rosters |> mutate(team_name = ifelse(name == i, ottoneu_team, team_name))
    new_roster_two <- rosters |> add_row(team_id = rosters |> filter(team_name == ottoneu_team) |> head(1) |> pull(team_id),
                                         team_name = ottoneu_team,
                                         fg_major_league_id = players |> filter(name == i) |> arrange(desc(avg_salary)) |> head(1) |> pull(fg_major_league_id),
                                         fg_minor_league_id = players |> filter(name == i) |> arrange(desc(avg_salary)) |> head(1) |> pull(fg_minor_league_id),
                                         name = i,
                                         mlb_team = players |> filter(name == i) |> arrange(desc(avg_salary)) |> head(1) |> pull(mlb_org),
                                         position_s = players |> filter(name == i) |> arrange(desc(avg_salary)) |> head(1) |> pull(position_s),
                                         salary = players |> filter(name == i) |> arrange(desc(avg_salary)) |> head(1) |> pull(last_10))
    added_pitcher <- case_when(roster_check == 1 ~ list(new_roster_one), 
                              TRUE ~ list(new_roster_two))
    added_pitcher <- added_pitcher[[1]]
    
    rosters_new <- added_pitcher
    
    updated <- get_scenarios_pitchers(rosters_new) |> 
      filter(team_name == ottoneu_team) |> 
      select(c(team_name, pitching_points, first_place, second_place, third_place, pitching_points_history))
    change_df <- data.frame(player = i,
                            playerid = ifelse(length(players |> filter(name == i) |> arrange(desc(avg_salary)) |> head(1) |> pull(fg_major_league_id)) == 0, "0",
                                              players |> filter(name == i) |> arrange(desc(avg_salary)) |> head(1) |> pull(fg_major_league_id)),
                            pitching_point_change = updated$pitching_points - original$pitching_points,
                            first_place_change = updated$first_place - original$first_place,
                            second_place_change = updated$second_place - original$second_place,
                            third_place_change = updated$third_place - original$third_place,
                            pitching_point_change_history = updated$pitching_points_history - original$pitching_points_history)
    change_df_original_pitcher <- bind_rows(change_df_original_pitcher, change_df)
  }
  return(change_df_original_pitcher)
}


get_top_fa_pitchers <- function(league_number, ottoneu_team, position_group_input = "All", number = 10) {
  rosters <- get_rosters(league_number)
  top_fa_pitchers <- get_fa_pitchers(rosters) |> 
    filter(if (position_group_input != "All") grepl(position_group_input, position) else TRUE) |>
    head(number) |> 
    filter(!is.na(position)) |> 
    rowwise() |> 
    mutate(pitching_point_change = add_pitcher(rosters, ottoneu_team, replace_accents(player_name)) |> 
             pull(pitching_point_change),
           pitching_point_change_history = add_pitcher(rosters, ottoneu_team, replace_accents(player_name)) |> 
             pull(pitching_point_change_history),
           dollars_per_spg = ifelse(pitching_point_change == 0, 0, dollars / pitching_point_change),
           dollars_per_spg_py = ifelse(pitching_point_change_history == 0, 0, dollars / pitching_point_change_history))
  return(top_fa_pitchers)
}

top_fa_pitchers_reactable <- function(league_number, ottoneu_team, position_group_input = "All", number = 20) {
  #ottoneu_teams <- as.data.frame(html_table(read_html(paste0("https://ottoneu.fangraphs.com/", league_number, "/standings")))[1]) |> select(Team) |> mutate(Team = trimws(gsub("[^a-zA-Z ]", "", Team))) |> as.vector()
  top_fa_pitchers <- get_top_fa_pitchers(league_number, ottoneu_team, position_group_input, number) |>
    select(c(player_name, position, dollars, pitching_point_change, dollars_per_spg, pitching_point_change_history, dollars_per_spg_py, w, sv, so, whip, era)) |>
    arrange(desc(pitching_point_change))
  coloring <- function(x) {
    x <- x[!is.na(x)]
    rgb(colorRamp(c("red", "white", "green"))(x), maxColorValue = 255)
  }
  coloring_opp <- function(x) {
    x <- x[!is.na(x)]
    rgb(colorRamp(c("red", "white", "green"))(x), maxColorValue = 255)
  }
  
  reactable <- reactable(
    top_fa_pitchers,
    columns = list(
      player_name = colDef(name = "Player", width = 150, filterable = TRUE),
      position = colDef(name = "Position", width = 75, filterable = TRUE),
      pitching_point_change = colDef(name = "SPG Current", width = 80, format = colFormat(digits = 1),
                                    style = function(value) {
                                      normalized <- (value - min(top_fa_pitchers$pitching_point_change)) / (max(top_fa_pitchers$pitching_point_change) - min(top_fa_pitchers$pitching_point_change))
                                      color <- coloring(normalized)
                                      list(background = color)
                                    }),
      pitching_point_change_history = colDef(name = "SPG Prior Year", width = 80, format = colFormat(digits = 1),
                                            style = function(value) {
                                              normalized <- (value - min(top_fa_pitchers$pitching_point_change_history)) / (max(top_fa_pitchers$pitching_point_change_history) - min(top_fa_pitchers$pitching_point_change_history))
                                              color <- coloring(normalized)
                                              list(background = color)
                                            }),
      dollars = colDef(name = "$$", width = 65,
                       style = function(value) {
                         normalized <- (value - min(top_fa_pitchers$dollars)) / (max(top_fa_pitchers$dollars) - min(top_fa_pitchers$dollars))
                         color <- coloring(normalized)
                         list(background = color)
                       }),
      dollars_per_spg = colDef(name = "$$/SPG", width = 70, format = colFormat(digits = 1)),
      dollars_per_spg_py = colDef(name = "$$/SPG PY", width = 70, format = colFormat(digits = 1)),
      w = colDef(name = "W", width = 50),
      sv = colDef(name = "SV", width = 50),
      so = colDef(name = "K", width = 50),
      whip = colDef(name = "WHIP", format = colFormat(digits = 2), width = 50),
      era = colDef(name = "ERA", format = colFormat(digits = 2), width = 50)),
    defaultColDef = colDef(
      header = function(value) gsub(".", " ", value, fixed = TRUE),
      #cell = function(value) format(value, nsmall = 1),
      #align = "center",
      #wit = 200,
      headerStyle = list(background = "#f7f7f8"),
      format = colFormat(digits = 0)),
    bordered = TRUE,
    highlight = TRUE,
    defaultPageSize = 20)
  
  return(reactable)
}


# free agent hitters reactable --------------------------------------------

free_agent_hitters <- function(league_id){
  #get rosters
  rosters_url <- paste0("https://ottoneu.fangraphs.com/", league_id, "/rosterexport?csv=1")
  rosters <- data.frame(read_csv(rosters_url)) |>
    clean_names() |>
    mutate(salary = as.integer(gsub("\\$", "", salary)),
           fg_major_league_id = as.character(fg_major_league_id))
  
  #get hitters
  hitters <- left_join(hitters_df, hitter_values |> select(c(playerid, system, dollars)), 
                       by = c("playerid"="playerid", "system" = "system")) |>
    left_join(rosters |> select(c(fg_major_league_id, team_name, salary)), 
              by = c("playerid" = "fg_major_league_id")) |>
    mutate(team_name = ifelse(is.na(team_name), "Free Agent", team_name),
           value = dollars - salary) |>
    left_join(players |> select(fg_major_league_id, avg_salary, last_10, roster, position_s), 
              by = c("playerid" = "fg_major_league_id")) |>
    rename("position" = "position_s") |>
    select(-minpos) |>
    mutate(hr_per600 = (600/ab)*hr,
           r_per600 = (600/ab)*r,
           rbi_per600 = (600/ab)*rbi,
           sb_per600 = (600/ab)*sb)
  
  #get and format free agents
  hitters_fa <- hitters |>
    filter(team_name == "Free Agent") |>
    mutate(position_group = case_when(grepl("OF", position) ~ "OF",
                                      grepl("2B", position) ~ "MI",
                                      grepl("SS", position) ~ "MI",
                                      grepl("3B", position) ~ "CI",
                                      grepl("1B", position) ~ "CI",
                                      grepl("C", position) ~ "C",
                                      TRUE ~ position)) |>
    group_by(position_group, playerid) |>
    summarize(dollars_avg = mean(dollars, na.rm = TRUE)) |>
    group_by(position_group) |>
    mutate(position_group_rank = rank(-dollars_avg)) |>
    ungroup() |>
    select(c(playerid, dollars_avg, position_group, position_group_rank)) |>
    left_join(hitters, by = "playerid", relationship = "many-to-many") |>
    mutate(position_roup_rank = paste0(position_group, position_group_rank),
           starting = case_when(position_group == "C" & position_group_rank == 1 ~ 1,
                                position_group == "CI" & position_group_rank <= 2 ~ 1,
                                position_group == "MI" & position_group_rank <= 3 ~ 1,
                                position_group == "OF" & position_group_rank <= 5 ~ 1,
                                position_group == "DH" & position_group_rank == 1 ~ 1,
                                TRUE ~ 0)) |>
    group_by(player_name, playerid, position_group, position_group_rank, position) |>
    summarize(ab = mean(ab),
              h = mean(h),
              hr = mean(hr),
              r = mean(r),
              rbi = mean(rbi),
              sb = mean(sb),
              dollars_sd = sd(dollars),
              dollars = mean(dollars_avg)) |>
    ungroup() |>
    mutate(avg = h / ab) |>
    arrange(desc(dollars)) |>
    rowwise() %>%
    mutate(
      catcher = ifelse(grepl("C", position), "C", ""),
      first = ifelse(grepl("1B", position), "CI", ""),
      third = ifelse(grepl("3B", position), "CI", ""),
      second = ifelse(grepl("2B", position), "MI", ""),
      shortstop = ifelse(grepl("SS", position), "MI", ""),
      outfield = ifelse(grepl("OF", position), "OF", ""),
      ut = ifelse(grepl("UT", position), "UT", ""),
      position_group2 = trimws(paste(
        catcher, first, second, shortstop, third, outfield, ut,
        collapse = "/"
      ))
    ) |>
    ungroup() |>
    mutate(position_group2 = trimws(gsub(" ", "/", position_group2)),
           position_group2 = gsub("///", "/", position_group2),
           position_group2 = gsub("//", "/", position_group2),
           position_group2 = gsub("//", "/", position_group2),
           position_group2 = gsub("//", "/", position_group2),
           position_group2 = gsub("MI/MI", "MI", position_group2),
           position_group2 = gsub("CI/CI", "CI", position_group2),
           position_group = position_group2) |>
    select(-c(catcher, first, third, shortstop, second, outfield, ut, position_group2)) |>
    select(c(player_name, position_group, position_group_rank, position, dollars, dollars_sd, h, hr, r, rbi, sb, avg, ab)) |>
    mutate(hr_per600 = (600/ab)*hr,
           r_per600 = (600/ab)*r,
           rbi_per600 = (600/ab)*rbi,
           sb_per600 = (600/ab)*sb)
  
  #hitters sub table
  hitters_risk <- bind_rows(
    hitters |>
      group_by(player_name, playerid, team_name, position) |>
      summarize(across(c(dollars, ab, hr, r, rbi, sb, hr_per600, r_per600, rbi_per600, sb_per600), \(x) mean(x, na.rm = TRUE))) |>
      ungroup() |>
      mutate(system = "average"),
    hitters |>
      group_by(player_name, playerid, team_name, position) |>
      summarize(across(c(dollars, ab, hr, r, rbi, sb, hr_per600, r_per600, rbi_per600, sb_per600), \(x) sd(x, na.rm = TRUE))) |>
      ungroup() |>
      mutate(system = "sd"),
    hitters |>
      group_by(player_name, playerid, team_name, position) |>
      summarize(across(c(dollars, ab, hr, r, rbi, sb, hr_per600, r_per600, rbi_per600, sb_per600), \(x) min(x, na.rm = TRUE))) |>
      ungroup() |>
      mutate(system = "min"),
    hitters |>
      group_by(player_name, playerid, team_name, position) |>
      summarize(across(c(dollars, ab, hr, r, rbi, sb, hr_per600, r_per600, rbi_per600, sb_per600), \(x) max(x, na.rm = TRUE))) |>
      ungroup() |>
      mutate(system = "max"),
    hitters |>
      select(c(player_name, playerid, team_name, position, dollars, ab, hr, r, rbi, sb, hr_per600, r_per600, rbi_per600, sb_per600, system)))
  
  
  #reactable
  hitters_react <- hitters_fa |> filter(!is.nan(dollars)) |> select(-c(h))
  coloring <- function(x) {
    x <- x[!is.na(x)]
    rgb(colorRamp(c("red", "white", "green"))(x), maxColorValue = 255)
  }
  coloring_opp <- function(x) {
    x <- x[!is.na(x)]
    rgb(colorRamp(c("green", "white", "red"))(x), maxColorValue = 255)
  }
  
  # Define the table
  reactable_hitters <- reactable(
    hitters_react,
    columns = list(
      player_name = colDef(name = "Player", minWidth = 170, filterable = TRUE),
      position_group = colDef(name = "Position Group", minWidth = 100, filterable = TRUE),
      position_group_rank = colDef(name = "Rank", align = "center"),
      position = colDef(name = "Position", minWidth = 100, filterable = TRUE),
      dollars = colDef(name = "$$", align = "center",
                       style = function(value) {
                         normalized <- (value - min(hitters_react$dollars)) / (max(hitters_react$dollars) - min(hitters_react$dollars))
                         color <- coloring(normalized)
                         list(background = color)
                       }),
      dollars_sd = colDef(name = "$ sd", align = "center",
                          style = function(value) {
                            normalized <- (value - min(hitters_react$dollars_sd, na.rm = TRUE)) / (max(hitters_react$dollars_sd, na.rm = TRUE) - min(hitters_react$dollars_sd, na.rm = TRUE))
                            color <- coloring_opp(normalized)
                            list(background = color)
                          }),
      hr = colDef(name = "HR", align = "center",
                  style = function(value) {
                    normalized <- (value - min(hitters_react$hr)) / (max(hitters_react$hr) - min(hitters_react$hr))
                    color <- coloring(normalized)
                    list(background = color)
                  }),
      r = colDef(name = "Runs", align = "center",
                 style = function(value) {
                   normalized <- (value - min(hitters_react$r)) / (max(hitters_react$r) - min(hitters_react$r))
                   color <- coloring(normalized)
                   list(background = color)
                 }),
      rbi = colDef(name = "RBI", align = "center",
                   style = function(value) {
                     normalized <- (value - min(hitters_react$rbi)) / (max(hitters_react$rbi) - min(hitters_react$rbi))
                     color <- coloring(normalized)
                     list(background = color)
                   }),
      sb = colDef(name = "SB", align = "center",
                  style = function(value) {
                    normalized <- (value - min(hitters_react$sb)) / (max(hitters_react$sb) - min(hitters_react$sb))
                    color <- coloring(normalized)
                    list(background = color)
                  }),
      avg = colDef(name = "Avg", align = "center", format = colFormat(digits = 3),
                   style = function(value) {
                     normalized <- (value - min(hitters_react$avg)) / (max(hitters_react$avg) - min(hitters_react$avg))
                     color <- coloring(normalized)
                     list(background = color)
                   }),
      ab = colDef(name = "AB", align = "center"),
      hr_per600 = colDef(name = "HR Rate", align = "center"),
      r_per600 = colDef(name = "R Rate", align = "center"),
      rbi_per600 = colDef(name = "RBI Rate", align = "center"),
      sb_per600 = colDef(name = "SB Rate", align = "center")
    ),
    defaultColDef = colDef(minWidth = 62, format = colFormat(digits = 0)),
    defaultPageSize = 20,
    fullWidth = FALSE,
    style = list(fontFamily = "Work Sans, sans-serif"),
    details = function(index){
      #risk_data <- CO2[CO2$Plant == data$Plant[index], ]
      risk_data <- hitters_risk[hitters_risk$player_name == hitters_react$player_name[index], ]
      risk_data_1 <- risk_data |> select(c(system, dollars, ab, hr, r, rbi, sb, hr_per600, r_per600, rbi_per600, sb_per600)) |> rename("scenario" = "system")
      htmltools::div(style = "padding: 1rem",
                     reactable(risk_data_1, outlined = TRUE,
                               defaultColDef = colDef(maxWidth = 80, format = colFormat(digits = 0)))
      )
    }
  )
  #output2 <- ifelse(output == "df", hitters_fa, ifelse(output == "table", reactable_hitters, "error"))
  #return(output2)
  reactable_hitters
}

#get rds and reactable

free_agent_hitters_rds <- function(league_id){
  #get rosters
  rosters_url <- paste0("https://ottoneu.fangraphs.com/", league_id, "/rosterexport?csv=1")
  rosters <- data.frame(read_csv(rosters_url)) |>
    clean_names() |>
    mutate(salary = as.integer(gsub("\\$", "", salary)),
           fg_major_league_id = as.character(fg_major_league_id))
  
  #get hitters
  hitters <- left_join(hitters_df, hitter_values |> select(c(playerid, system, dollars)), 
                       by = c("playerid"="playerid", "system" = "system")) |>
    left_join(rosters |> select(c(fg_major_league_id, team_name, salary)), 
              by = c("playerid" = "fg_major_league_id")) |>
    mutate(team_name = ifelse(is.na(team_name), "Free Agent", team_name),
           value = dollars - salary) |>
    left_join(players |> select(fg_major_league_id, avg_salary, last_10, roster, position_s), 
              by = c("playerid" = "fg_major_league_id")) |>
    rename("position" = "position_s") |>
    select(-minpos) |>
    mutate(hr_per600 = (600/ab)*hr,
           r_per600 = (600/ab)*r,
           rbi_per600 = (600/ab)*rbi,
           sb_per600 = (600/ab)*sb)
  
  #get and format free agents
  hitters_fa <- hitters |>
    filter(team_name == "Free Agent") |>
    mutate(position_group = case_when(grepl("OF", position) ~ "OF",
                                      grepl("2B", position) ~ "MI",
                                      grepl("SS", position) ~ "MI",
                                      grepl("3B", position) ~ "CI",
                                      grepl("1B", position) ~ "CI",
                                      grepl("C", position) ~ "C",
                                      TRUE ~ position)) |>
    group_by(position_group, playerid) |>
    summarize(dollars_avg = mean(dollars, na.rm = TRUE)) |>
    group_by(position_group) |>
    mutate(position_group_rank = rank(-dollars_avg)) |>
    ungroup() |>
    select(c(playerid, dollars_avg, position_group, position_group_rank)) |>
    left_join(hitters, by = "playerid", relationship = "many-to-many") |>
    mutate(position_roup_rank = paste0(position_group, position_group_rank),
           starting = case_when(position_group == "C" & position_group_rank == 1 ~ 1,
                                position_group == "CI" & position_group_rank <= 2 ~ 1,
                                position_group == "MI" & position_group_rank <= 3 ~ 1,
                                position_group == "OF" & position_group_rank <= 5 ~ 1,
                                position_group == "DH" & position_group_rank == 1 ~ 1,
                                TRUE ~ 0)) |>
    group_by(player_name, playerid, position_group, position_group_rank, position) |>
    summarize(ab = mean(ab),
              h = mean(h),
              hr = mean(hr),
              r = mean(r),
              rbi = mean(rbi),
              sb = mean(sb),
              dollars_sd = sd(dollars),
              dollars = mean(dollars_avg)) |>
    ungroup() |>
    mutate(avg = h / ab) |>
    arrange(desc(dollars)) |>
    rowwise() %>%
    mutate(
      catcher = ifelse(grepl("C", position), "C", ""),
      first = ifelse(grepl("1B", position), "CI", ""),
      third = ifelse(grepl("3B", position), "CI", ""),
      second = ifelse(grepl("2B", position), "MI", ""),
      shortstop = ifelse(grepl("SS", position), "MI", ""),
      outfield = ifelse(grepl("OF", position), "OF", ""),
      ut = ifelse(grepl("UT", position), "UT", ""),
      position_group2 = trimws(paste(
        catcher, first, second, shortstop, third, outfield, ut,
        collapse = "/"
      ))
    ) |>
    ungroup() |>
    mutate(position_group2 = trimws(gsub(" ", "/", position_group2)),
           position_group2 = gsub("///", "/", position_group2),
           position_group2 = gsub("//", "/", position_group2),
           position_group2 = gsub("//", "/", position_group2),
           position_group2 = gsub("//", "/", position_group2),
           position_group2 = gsub("MI/MI", "MI", position_group2),
           position_group2 = gsub("CI/CI", "CI", position_group2),
           position_group = position_group2) |>
    select(-c(catcher, first, third, shortstop, second, outfield, ut, position_group2)) |>
    select(c(player_name, position_group, position_group_rank, position, dollars, dollars_sd, h, hr, r, rbi, sb, avg, ab)) |>
    mutate(hr_per600 = (600/ab)*hr,
           r_per600 = (600/ab)*r,
           rbi_per600 = (600/ab)*rbi,
           sb_per600 = (600/ab)*sb) %>%
    head(500)
  return(hitters_fa)
}

free_agent_hitters_reactable <- function(league_id, df) {
  #get rosters
  rosters_url <- paste0("https://ottoneu.fangraphs.com/", league_id, "/rosterexport?csv=1")
  rosters <- data.frame(read_csv(rosters_url)) |>
    clean_names() |>
    mutate(salary = as.integer(gsub("\\$", "", salary)),
           fg_major_league_id = as.character(fg_major_league_id))
  
  #get hitters
  hitters <- left_join(hitters_df, hitter_values |> select(c(playerid, system, dollars)), 
                       by = c("playerid"="playerid", "system" = "system")) |>
    left_join(rosters |> select(c(fg_major_league_id, team_name, salary)), 
              by = c("playerid" = "fg_major_league_id")) |>
    mutate(team_name = ifelse(is.na(team_name), "Free Agent", team_name),
           value = dollars - salary) |>
    left_join(players |> select(fg_major_league_id, avg_salary, last_10, roster, position_s), 
              by = c("playerid" = "fg_major_league_id")) |>
    rename("position" = "position_s") |>
    select(-minpos) |>
    mutate(hr_per600 = (600/ab)*hr,
           r_per600 = (600/ab)*r,
           rbi_per600 = (600/ab)*rbi,
           sb_per600 = (600/ab)*sb)
  #hitters sub table
  hitters_risk <- bind_rows(
    hitters |>
      group_by(player_name, playerid, team_name, position) |>
      summarize(across(c(dollars, ab, hr, r, rbi, sb, hr_per600, r_per600, rbi_per600, sb_per600), \(x) mean(x, na.rm = TRUE))) |>
      ungroup() |>
      mutate(system = "average"),
    hitters |>
      group_by(player_name, playerid, team_name, position) |>
      summarize(across(c(dollars, ab, hr, r, rbi, sb, hr_per600, r_per600, rbi_per600, sb_per600), \(x) sd(x, na.rm = TRUE))) |>
      ungroup() |>
      mutate(system = "sd"),
    hitters |>
      group_by(player_name, playerid, team_name, position) |>
      summarize(across(c(dollars, ab, hr, r, rbi, sb, hr_per600, r_per600, rbi_per600, sb_per600), \(x) min(x, na.rm = TRUE))) |>
      ungroup() |>
      mutate(system = "min"),
    hitters |>
      group_by(player_name, playerid, team_name, position) |>
      summarize(across(c(dollars, ab, hr, r, rbi, sb, hr_per600, r_per600, rbi_per600, sb_per600), \(x) max(x, na.rm = TRUE))) |>
      ungroup() |>
      mutate(system = "max"),
    hitters |>
      select(c(player_name, playerid, team_name, position, dollars, ab, hr, r, rbi, sb, hr_per600, r_per600, rbi_per600, sb_per600, system)))
  
  
  #reactable
  hitters_react <- df |> filter(!is.nan(dollars)) |> select(-c(h))
  coloring <- function(x) {
    x <- x[!is.na(x)]
    rgb(colorRamp(c("red", "white", "green"))(x), maxColorValue = 255)
  }
  coloring_opp <- function(x) {
    x <- x[!is.na(x)]
    rgb(colorRamp(c("green", "white", "red"))(x), maxColorValue = 255)
  }
  
  # Define the table
  reactable_hitters <- reactable(
    hitters_react,
    columns = list(
      player_name = colDef(name = "Player", minWidth = 170, filterable = TRUE),
      position_group = colDef(name = "Position Group", minWidth = 100, filterable = TRUE),
      position_group_rank = colDef(name = "Rank", align = "center"),
      position = colDef(name = "Position", minWidth = 100, filterable = TRUE),
      dollars = colDef(name = "$$", align = "center",
                       style = function(value) {
                         normalized <- (value - min(hitters_react$dollars)) / (max(hitters_react$dollars) - min(hitters_react$dollars))
                         color <- coloring(normalized)
                         list(background = color)
                       }),
      dollars_sd = colDef(name = "$ sd", align = "center",
                          style = function(value) {
                            normalized <- (value - min(hitters_react$dollars_sd, na.rm = TRUE)) / (max(hitters_react$dollars_sd, na.rm = TRUE) - min(hitters_react$dollars_sd, na.rm = TRUE))
                            color <- coloring_opp(normalized)
                            list(background = color)
                          }),
      hr = colDef(name = "HR", align = "center",
                  style = function(value) {
                    normalized <- (value - min(hitters_react$hr)) / (max(hitters_react$hr) - min(hitters_react$hr))
                    color <- coloring(normalized)
                    list(background = color)
                  }),
      r = colDef(name = "Runs", align = "center",
                 style = function(value) {
                   normalized <- (value - min(hitters_react$r)) / (max(hitters_react$r) - min(hitters_react$r))
                   color <- coloring(normalized)
                   list(background = color)
                 }),
      rbi = colDef(name = "RBI", align = "center",
                   style = function(value) {
                     normalized <- (value - min(hitters_react$rbi)) / (max(hitters_react$rbi) - min(hitters_react$rbi))
                     color <- coloring(normalized)
                     list(background = color)
                   }),
      sb = colDef(name = "SB", align = "center",
                  style = function(value) {
                    normalized <- (value - min(hitters_react$sb)) / (max(hitters_react$sb) - min(hitters_react$sb))
                    color <- coloring(normalized)
                    list(background = color)
                  }),
      avg = colDef(name = "Avg", align = "center", format = colFormat(digits = 3),
                   style = function(value) {
                     normalized <- (value - min(hitters_react$avg)) / (max(hitters_react$avg) - min(hitters_react$avg))
                     color <- coloring(normalized)
                     list(background = color)
                   }),
      ab = colDef(name = "AB", align = "center"),
      hr_per600 = colDef(name = "HR Rate", align = "center"),
      r_per600 = colDef(name = "R Rate", align = "center"),
      rbi_per600 = colDef(name = "RBI Rate", align = "center"),
      sb_per600 = colDef(name = "SB Rate", align = "center")
    ),
    defaultColDef = colDef(minWidth = 62, format = colFormat(digits = 0)),
    defaultPageSize = 20,
    fullWidth = FALSE,
    style = list(fontFamily = "Work Sans, sans-serif"),
    details = function(index){
      #risk_data <- CO2[CO2$Plant == data$Plant[index], ]
      risk_data <- hitters_risk[hitters_risk$player_name == hitters_react$player_name[index], ]
      risk_data_1 <- risk_data |> select(c(system, dollars, ab, hr, r, rbi, sb, hr_per600, r_per600, rbi_per600, sb_per600)) |> rename("scenario" = "system")
      htmltools::div(style = "padding: 1rem",
                     reactable(risk_data_1, outlined = TRUE,
                               defaultColDef = colDef(maxWidth = 80, format = colFormat(digits = 0)))
      )
    }
  )
  #output2 <- ifelse(output == "df", hitters_fa, ifelse(output == "table", reactable_hitters, "error"))
  #return(output2)
  reactable_hitters
}

# free agent pitchers reactable -------------------------------------------

free_agent_pitchers <- function(league_id){
  #get rosters
  rosters_url <- paste0("https://ottoneu.fangraphs.com/", league_id, "/rosterexport?csv=1")
  rosters <- data.frame(read_csv(rosters_url)) |>
    clean_names() |>
    mutate(salary = as.integer(gsub("\\$", "", salary)),
           fg_major_league_id = as.character(fg_major_league_id))
  
  #get pitchers
  pitchers <- left_join(pitchers_df, pitcher_values |> select(c(playerid, system, dollars)), 
                        by = c("playerid"="playerid", "system" = "system")) |>
    left_join(rosters |> select(c(fg_major_league_id, team_name, salary)), 
              by = c("playerid" = "fg_major_league_id")) |>
    mutate(team_name = ifelse(is.na(team_name), "Free Agent", team_name),
           value = dollars - salary) |>
    left_join(players |> select(fg_major_league_id, avg_salary, last_10, roster, position_s), 
              by = c("playerid" = "fg_major_league_id")) |>
    rename("position" = "position_s") |>
    mutate(whip = (h+bb) / ip,
           era = (er/ip) * 9,
           k_9 = so / (ip/9),
           bb_9 = bb / (ip/9),
           k_bb = so/bb) |>
    filter(!is.na(dollars))
  
  #get and format free agents
  pitchers_fa <- pitchers |>
    filter(team_name == "Free Agent") |>
    group_by(position, playerid) |>
    summarize(dollars_avg = mean(dollars, na.rm = TRUE)) |>
    ungroup() |>
    mutate(position_rank = rank(-dollars_avg)) |>
    ungroup() |>
    select(c(playerid, dollars_avg, position, position_rank)) |>
    left_join(pitchers |> select(-c(position)), by = "playerid", relationship = "many-to-many") |>
    mutate(position_rank = paste0(position, position_rank)) |>
    group_by(player_name, playerid, position, position_rank) |>
    summarize(ip = mean(ip),
              w = mean(w),
              er = mean(er),
              h = mean(h),
              bb = mean(bb),
              sv = mean(sv),
              so = mean(so),
              dollars_sd = sd(dollars),
              dollars = mean(dollars_avg)) |>
    ungroup() |>
    mutate(whip = (h+bb) / ip,
           era = (er/ip) * 9,
           k_9 = so / (ip/9),
           bb_9 = bb / (ip/9),
           k_bb = so/bb) |>
    select(c(player_name, position, position_rank, dollars, dollars_sd, w, so, sv, era, whip, ip, k_9, k_bb))
  
  #hitters sub table
  pitchers_risk <- bind_rows(
    pitchers |>
      group_by(player_name, playerid, team_name, position) |>
      summarize(across(c(dollars, ip, w, sv, so, era, whip, k_9, bb_9, k_bb), \(x) mean(x, na.rm = TRUE))) |>
      ungroup() |>
      mutate(system = "average"),
    pitchers |>
      group_by(player_name, playerid, team_name, position) |>
      summarize(across(c(dollars, ip, w, sv, so, era, whip, k_9, bb_9, k_bb), \(x) sd(x, na.rm = TRUE))) |>
      ungroup() |>
      mutate(system = "sd"),
    pitchers |>
      group_by(player_name, playerid, team_name, position) |>
      summarize(across(c(dollars, ip, w, sv, so, era, whip, k_9, bb_9, k_bb), \(x) min(x, na.rm = TRUE))) |>
      ungroup() |>
      mutate(system = "min"),
    pitchers |>
      group_by(player_name, playerid, team_name, position) |>
      summarize(across(c(dollars, ip, w, sv, so, era, whip, k_9, bb_9, k_bb), \(x) max(x, na.rm = TRUE))) |>
      ungroup() |>
      mutate(system = "max"),
    pitchers |>
      select(c(player_name, playerid, team_name, position, dollars, ip, w, sv, so, era, whip, k_9, bb_9, k_bb, system)))
  
  
  #reactable
  pitchers_react <- pitchers_fa |> filter(!is.nan(dollars), era < 5.75) |> arrange(desc(dollars))
  coloring <- function(x) {
    x <- x[!is.na(x)]
    rgb(colorRamp(c("red", "white", "green"))(x), maxColorValue = 255)
  }
  coloring_opp <- function(x) {
    x <- x[!is.na(x)]
    rgb(colorRamp(c("green", "white", "red"))(x), maxColorValue = 255)
  }
  
  # Define the table
  reactable_pitchers <- reactable(
    pitchers_react,
    columns = list(
      player_name = colDef(name = "Player", minWidth = 170, filterable = TRUE),
      position = colDef(name = "Position", maxWidth = 80, filterable = TRUE),
      position_rank = colDef(name = "Rank", align = "center"),
      dollars = colDef(name = "$$", align = "center",
                       style = function(value) {
                         normalized <- (value - min(pitchers_react$dollars)) / (max(pitchers_react$dollars) - min(pitchers_react$dollars))
                         color <- coloring(normalized)
                         list(background = color)
                       }),
      dollars_sd = colDef(name = "$ sd", align = "center",
                          style = function(value) {
                            normalized <- (value - min(pitchers_react$dollars_sd, na.rm = TRUE)) / (max(pitchers_react$dollars_sd, na.rm = TRUE) - min(pitchers_react$dollars_sd, na.rm = TRUE))
                            color <- coloring_opp(normalized)
                            list(background = color)
                          }),
      w = colDef(name = "W", align = "center",
                 style = function(value) {
                   normalized <- (value - min(pitchers_react$w)) / (max(pitchers_react$w) - min(pitchers_react$w))
                   color <- coloring(normalized)
                   list(background = color)
                 }),
      so = colDef(name = "K", align = "center",
                  style = function(value) {
                    normalized <- (value - min(pitchers_react$so)) / (max(pitchers_react$so) - min(pitchers_react$so))
                    color <- coloring(normalized)
                    list(background = color)
                  }),
      sv = colDef(name = "SV", align = "center",
                  style = function(value) {
                    normalized <- (value - min(pitchers_react$sv)) / (max(pitchers_react$sv) - min(pitchers_react$sv))
                    color <- coloring(normalized)
                    list(background = color)
                  }),
      era = colDef(name = "ERA", align = "center", format = colFormat(digits = 2),
                   style = function(value) {
                     normalized <- (value - min(pitchers_react$era)) / (max(pitchers_react$era) - min(pitchers_react$era))
                     color <- coloring_opp(normalized)
                     list(background = color)
                   }),
      whip = colDef(name = "WHIP", align = "center", format = colFormat(digits = 2),
                    style = function(value) {
                      normalized <- (value - min(pitchers_react$whip)) / (max(pitchers_react$whip) - min(pitchers_react$whip))
                      color <- coloring_opp(normalized)
                      list(background = color)
                    }),
      ip = colDef(name = "IP", align = "center"),
      k_9 = colDef(name = "K/9", align = "center", format = colFormat(digits = 1)),
      k_bb = colDef(name = "K-BB", align = "center", format = colFormat(digits = 1))
    ),
    defaultColDef = colDef(minWidth = 62, format = colFormat(digits = 0)),
    defaultPageSize = 20,
    fullWidth = TRUE,
    style = list(fontFamily = "Work Sans, sans-serif"),
    details = function(index){
      #risk_data <- CO2[CO2$Plant == data$Plant[index], ]
      risk_data <- pitchers_risk[pitchers_risk$player_name == pitchers_react$player_name[index], ]
      risk_data_1 <- risk_data |> select(c(system, dollars, ip, w, so, sv, era, whip, k_9, k_bb)) |> rename("scenario" = "system")
      htmltools::div(style = "padding: 1rem",
                     reactable(risk_data_1, outlined = TRUE,
                               columns = list(
                                 era = colDef(name = "era", format = colFormat(digits = 2)),
                                 whip = colDef(name = "whip", format = colFormat(digits = 2)),
                                 k_9 = colDef(name = "K/9", format = colFormat(digits = 1)),
                                 k_bb = colDef(name = "K-BB", format = colFormat(digits = 1))
                               ),
                               defaultColDef = colDef(maxWidth = 80, format = colFormat(digits = 0)))
      )
    }
  )
  #output2 <- ifelse(output == "df", hitters_fa, ifelse(output == "table", reactable_hitters, "error"))
  #return(output2)
  reactable_pitchers
}


# get rds

free_agent_pitchers_rds <- function(league_id){
  #get rosters
  rosters_url <- paste0("https://ottoneu.fangraphs.com/", league_id, "/rosterexport?csv=1")
  rosters <- data.frame(read_csv(rosters_url)) |>
    clean_names() |>
    mutate(salary = as.integer(gsub("\\$", "", salary)),
           fg_major_league_id = as.character(fg_major_league_id))
  
  #get pitchers
  pitchers <- left_join(pitchers_df, pitcher_values |> select(c(playerid, system, dollars)), 
                        by = c("playerid"="playerid", "system" = "system")) |>
    left_join(rosters |> select(c(fg_major_league_id, team_name, salary)), 
              by = c("playerid" = "fg_major_league_id")) |>
    mutate(team_name = ifelse(is.na(team_name), "Free Agent", team_name),
           value = dollars - salary) |>
    left_join(players |> select(fg_major_league_id, avg_salary, last_10, roster, position_s), 
              by = c("playerid" = "fg_major_league_id")) |>
    rename("position" = "position_s") |>
    mutate(whip = (h+bb) / ip,
           era = (er/ip) * 9,
           k_9 = so / (ip/9),
           bb_9 = bb / (ip/9),
           k_bb = so/bb) |>
    filter(!is.na(dollars))
  
  #get and format free agents
  pitchers_fa <- pitchers |>
    filter(team_name == "Free Agent") |>
    group_by(position, playerid) |>
    summarize(dollars_avg = mean(dollars, na.rm = TRUE)) |>
    ungroup() |>
    mutate(position_rank = rank(-dollars_avg)) |>
    ungroup() |>
    select(c(playerid, dollars_avg, position, position_rank)) |>
    left_join(pitchers |> select(-c(position)), by = "playerid", relationship = "many-to-many") |>
    mutate(position_rank = paste0(position, position_rank)) |>
    group_by(player_name, playerid, position, position_rank) |>
    summarize(ip = mean(ip),
              w = mean(w),
              er = mean(er),
              h = mean(h),
              bb = mean(bb),
              sv = mean(sv),
              so = mean(so),
              dollars_sd = sd(dollars),
              dollars = mean(dollars_avg)) |>
    ungroup() |>
    mutate(whip = (h+bb) / ip,
           era = (er/ip) * 9,
           k_9 = so / (ip/9),
           bb_9 = bb / (ip/9),
           k_bb = so/bb) |>
    select(c(player_name, position, position_rank, dollars, dollars_sd, w, so, sv, era, whip, ip, k_9, k_bb)) %>%
    head(500)
  return(pitchers_fa)
}

free_agent_pitchers_reactable <- function(league_id, df) {
  #reactable
  pitchers_react <- df |> filter(!is.nan(dollars), era < 5.75) |> arrange(desc(dollars))
  coloring <- function(x) {
    x <- x[!is.na(x)]
    rgb(colorRamp(c("red", "white", "green"))(x), maxColorValue = 255)
  }
  coloring_opp <- function(x) {
    x <- x[!is.na(x)]
    rgb(colorRamp(c("green", "white", "red"))(x), maxColorValue = 255)
  }
  rosters_url <- paste0("https://ottoneu.fangraphs.com/", league_id, "/rosterexport?csv=1")
  rosters <- data.frame(read_csv(rosters_url)) |>
    clean_names() |>
    mutate(salary = as.integer(gsub("\\$", "", salary)),
           fg_major_league_id = as.character(fg_major_league_id))
  
  #get pitchers
  pitchers <- left_join(pitchers_df, pitcher_values |> select(c(playerid, system, dollars)), 
                        by = c("playerid"="playerid", "system" = "system")) |>
    left_join(rosters |> select(c(fg_major_league_id, team_name, salary)), 
              by = c("playerid" = "fg_major_league_id")) |>
    mutate(team_name = ifelse(is.na(team_name), "Free Agent", team_name),
           value = dollars - salary) |>
    left_join(players |> select(fg_major_league_id, avg_salary, last_10, roster, position_s), 
              by = c("playerid" = "fg_major_league_id")) |>
    rename("position" = "position_s") |>
    mutate(whip = (h+bb) / ip,
           era = (er/ip) * 9,
           k_9 = so / (ip/9),
           bb_9 = bb / (ip/9),
           k_bb = so/bb) |>
    filter(!is.na(dollars))
  #hitters sub table
  pitchers_risk <- bind_rows(
    pitchers |>
      group_by(player_name, playerid, team_name, position) |>
      summarize(across(c(dollars, ip, w, sv, so, era, whip, k_9, bb_9, k_bb), \(x) mean(x, na.rm = TRUE))) |>
      ungroup() |>
      mutate(system = "average"),
    pitchers |>
      group_by(player_name, playerid, team_name, position) |>
      summarize(across(c(dollars, ip, w, sv, so, era, whip, k_9, bb_9, k_bb), \(x) sd(x, na.rm = TRUE))) |>
      ungroup() |>
      mutate(system = "sd"),
    pitchers |>
      group_by(player_name, playerid, team_name, position) |>
      summarize(across(c(dollars, ip, w, sv, so, era, whip, k_9, bb_9, k_bb), \(x) min(x, na.rm = TRUE))) |>
      ungroup() |>
      mutate(system = "min"),
    pitchers |>
      group_by(player_name, playerid, team_name, position) |>
      summarize(across(c(dollars, ip, w, sv, so, era, whip, k_9, bb_9, k_bb), \(x) max(x, na.rm = TRUE))) |>
      ungroup() |>
      mutate(system = "max"),
    pitchers |>
      select(c(player_name, playerid, team_name, position, dollars, ip, w, sv, so, era, whip, k_9, bb_9, k_bb, system)))
  
  # Define the table
  reactable_pitchers <- reactable(
    pitchers_react,
    columns = list(
      player_name = colDef(name = "Player", minWidth = 170, filterable = TRUE),
      position = colDef(name = "Position", maxWidth = 80, filterable = TRUE),
      position_rank = colDef(name = "Rank", align = "center"),
      dollars = colDef(name = "$$", align = "center",
                       style = function(value) {
                         normalized <- (value - min(pitchers_react$dollars)) / (max(pitchers_react$dollars) - min(pitchers_react$dollars))
                         color <- coloring(normalized)
                         list(background = color)
                       }),
      dollars_sd = colDef(name = "$ sd", align = "center",
                          style = function(value) {
                            normalized <- (value - min(pitchers_react$dollars_sd, na.rm = TRUE)) / (max(pitchers_react$dollars_sd, na.rm = TRUE) - min(pitchers_react$dollars_sd, na.rm = TRUE))
                            color <- coloring_opp(normalized)
                            list(background = color)
                          }),
      w = colDef(name = "W", align = "center",
                 style = function(value) {
                   normalized <- (value - min(pitchers_react$w)) / (max(pitchers_react$w) - min(pitchers_react$w))
                   color <- coloring(normalized)
                   list(background = color)
                 }),
      so = colDef(name = "K", align = "center",
                  style = function(value) {
                    normalized <- (value - min(pitchers_react$so)) / (max(pitchers_react$so) - min(pitchers_react$so))
                    color <- coloring(normalized)
                    list(background = color)
                  }),
      sv = colDef(name = "SV", align = "center",
                  style = function(value) {
                    normalized <- (value - min(pitchers_react$sv)) / (max(pitchers_react$sv) - min(pitchers_react$sv))
                    color <- coloring(normalized)
                    list(background = color)
                  }),
      era = colDef(name = "ERA", align = "center", format = colFormat(digits = 2),
                   style = function(value) {
                     normalized <- (value - min(pitchers_react$era)) / (max(pitchers_react$era) - min(pitchers_react$era))
                     color <- coloring_opp(normalized)
                     list(background = color)
                   }),
      whip = colDef(name = "WHIP", align = "center", format = colFormat(digits = 2),
                    style = function(value) {
                      normalized <- (value - min(pitchers_react$whip)) / (max(pitchers_react$whip) - min(pitchers_react$whip))
                      color <- coloring_opp(normalized)
                      list(background = color)
                    }),
      ip = colDef(name = "IP", align = "center"),
      k_9 = colDef(name = "K/9", align = "center", format = colFormat(digits = 1)),
      k_bb = colDef(name = "K-BB", align = "center", format = colFormat(digits = 1))
    ),
    defaultColDef = colDef(minWidth = 62, format = colFormat(digits = 0)),
    defaultPageSize = 20,
    fullWidth = TRUE,
    style = list(fontFamily = "Work Sans, sans-serif"),
    details = function(index){
      #risk_data <- CO2[CO2$Plant == data$Plant[index], ]
      risk_data <- pitchers_risk[pitchers_risk$player_name == pitchers_react$player_name[index], ]
      risk_data_1 <- risk_data |> select(c(system, dollars, ip, w, so, sv, era, whip, k_9, k_bb)) |> rename("scenario" = "system")
      htmltools::div(style = "padding: 1rem",
                     reactable(risk_data_1, outlined = TRUE,
                               columns = list(
                                 era = colDef(name = "era", format = colFormat(digits = 2)),
                                 whip = colDef(name = "whip", format = colFormat(digits = 2)),
                                 k_9 = colDef(name = "K/9", format = colFormat(digits = 1)),
                                 k_bb = colDef(name = "K-BB", format = colFormat(digits = 1))
                               ),
                               defaultColDef = colDef(maxWidth = 80, format = colFormat(digits = 0)))
      )
    }
  )
  #output2 <- ifelse(output == "df", hitters_fa, ifelse(output == "table", reactable_hitters, "error"))
  #return(output2)
  reactable_pitchers
}


# all players -------------------------------------------------------------

# hitters
hitters <- left_join(hitters_df, hitter_values |> select(c(playerid, system, dollars)), 
                     by = c("playerid"="playerid", "system" = "system")) |>
  left_join(players |> select(fg_major_league_id, avg_salary, last_10, roster, position_s), 
            by = c("playerid" = "fg_major_league_id")) |>
  rename("position" = "position_s") |>
  select(-minpos) |>
  mutate(hr_per600 = (600/ab)*hr,
         r_per600 = (600/ab)*r,
         rbi_per600 = (600/ab)*rbi,
         sb_per600 = (600/ab)*sb)

#get and format free agents
free_agent_all_hitters_rds <- hitters |>
  mutate(position_group = case_when(grepl("OF", position) ~ "OF",
                                    grepl("2B", position) ~ "MI",
                                    grepl("SS", position) ~ "MI",
                                    grepl("3B", position) ~ "CI",
                                    grepl("1B", position) ~ "CI",
                                    grepl("C", position) ~ "C",
                                    TRUE ~ position)) |>
  group_by(position_group, playerid) |>
  summarize(dollars_avg = mean(dollars, na.rm = TRUE)) |>
  group_by(position_group) |>
  mutate(position_group_rank = rank(-dollars_avg)) |>
  ungroup() |>
  select(c(playerid, dollars_avg, position_group, position_group_rank)) |>
  left_join(hitters, by = "playerid", relationship = "many-to-many") |>
  mutate(position_roup_rank = paste0(position_group, position_group_rank),
         starting = case_when(position_group == "C" & position_group_rank == 1 ~ 1,
                              position_group == "CI" & position_group_rank <= 2 ~ 1,
                              position_group == "MI" & position_group_rank <= 3 ~ 1,
                              position_group == "OF" & position_group_rank <= 5 ~ 1,
                              position_group == "DH" & position_group_rank == 1 ~ 1,
                              TRUE ~ 0)) |>
  group_by(player_name, playerid, position_group, position_group_rank, position) |>
  summarize(ab = mean(ab),
            h = mean(h),
            hr = mean(hr),
            r = mean(r),
            rbi = mean(rbi),
            sb = mean(sb),
            dollars_sd = sd(dollars),
            dollars = mean(dollars_avg)) |>
  ungroup() |>
  mutate(avg = h / ab) |>
  arrange(desc(dollars)) |>
  rowwise() %>%
  mutate(
    catcher = ifelse(grepl("C", position), "C", ""),
    first = ifelse(grepl("1B", position), "CI", ""),
    third = ifelse(grepl("3B", position), "CI", ""),
    second = ifelse(grepl("2B", position), "MI", ""),
    shortstop = ifelse(grepl("SS", position), "MI", ""),
    outfield = ifelse(grepl("OF", position), "OF", ""),
    ut = ifelse(grepl("UT", position), "UT", ""),
    position_group2 = trimws(paste(
      catcher, first, second, shortstop, third, outfield, ut,
      collapse = "/"
    ))
  ) |>
  ungroup() |>
  mutate(position_group2 = trimws(gsub(" ", "/", position_group2)),
         position_group2 = gsub("///", "/", position_group2),
         position_group2 = gsub("//", "/", position_group2),
         position_group2 = gsub("//", "/", position_group2),
         position_group2 = gsub("//", "/", position_group2),
         position_group2 = gsub("MI/MI", "MI", position_group2),
         position_group2 = gsub("CI/CI", "CI", position_group2),
         position_group = position_group2) |>
  select(-c(catcher, first, third, shortstop, second, outfield, ut, position_group2)) |>
  select(c(player_name, position_group, position_group_rank, position, dollars, dollars_sd, h, hr, r, rbi, sb, avg, ab)) |>
  mutate(hr_per600 = (600/ab)*hr,
         r_per600 = (600/ab)*r,
         rbi_per600 = (600/ab)*rbi,
         sb_per600 = (600/ab)*sb) %>%
  head(500)

free_agent_hitters_all_reactable <- function(df) {
  
  #get hitters
  hitters <- left_join(hitters_df, hitter_values |> select(c(playerid, system, dollars)), 
                       by = c("playerid"="playerid", "system" = "system")) |>
    left_join(players |> select(fg_major_league_id, avg_salary, last_10, roster, position_s), 
              by = c("playerid" = "fg_major_league_id")) |>
    rename("position" = "position_s") |>
    select(-minpos) |>
    mutate(hr_per600 = (600/ab)*hr,
           r_per600 = (600/ab)*r,
           rbi_per600 = (600/ab)*rbi,
           sb_per600 = (600/ab)*sb)
  #hitters sub table
  hitters_risk <- bind_rows(
    hitters |>
      group_by(player_name, playerid, position) |>
      summarize(across(c(dollars, ab, hr, r, rbi, sb, hr_per600, r_per600, rbi_per600, sb_per600), \(x) mean(x, na.rm = TRUE))) |>
      ungroup() |>
      mutate(system = "average"),
    hitters |>
      group_by(player_name, playerid, position) |>
      summarize(across(c(dollars, ab, hr, r, rbi, sb, hr_per600, r_per600, rbi_per600, sb_per600), \(x) sd(x, na.rm = TRUE))) |>
      ungroup() |>
      mutate(system = "sd"),
    hitters |>
      group_by(player_name, playerid, position) |>
      summarize(across(c(dollars, ab, hr, r, rbi, sb, hr_per600, r_per600, rbi_per600, sb_per600), \(x) min(x, na.rm = TRUE))) |>
      ungroup() |>
      mutate(system = "min"),
    hitters |>
      group_by(player_name, playerid, position) |>
      summarize(across(c(dollars, ab, hr, r, rbi, sb, hr_per600, r_per600, rbi_per600, sb_per600), \(x) max(x, na.rm = TRUE))) |>
      ungroup() |>
      mutate(system = "max"),
    hitters |>
      select(c(player_name, playerid, position, dollars, ab, hr, r, rbi, sb, hr_per600, r_per600, rbi_per600, sb_per600, system)))
  
  
  #reactable
  hitters_react <- df |> filter(!is.nan(dollars)) |> select(-c(h))
  coloring <- function(x) {
    x <- x[!is.na(x)]
    rgb(colorRamp(c("red", "white", "green"))(x), maxColorValue = 255)
  }
  coloring_opp <- function(x) {
    x <- x[!is.na(x)]
    rgb(colorRamp(c("green", "white", "red"))(x), maxColorValue = 255)
  }
  
  # Define the table
  reactable_hitters <- reactable(
    hitters_react,
    columns = list(
      player_name = colDef(name = "Player", minWidth = 170, filterable = TRUE),
      position_group = colDef(name = "Position Group", minWidth = 100, filterable = TRUE),
      position_group_rank = colDef(name = "Rank", align = "center"),
      position = colDef(name = "Position", minWidth = 100, filterable = TRUE),
      dollars = colDef(name = "$$", align = "center",
                       style = function(value) {
                         normalized <- (value - min(hitters_react$dollars)) / (max(hitters_react$dollars) - min(hitters_react$dollars))
                         color <- coloring(normalized)
                         list(background = color)
                       }),
      dollars_sd = colDef(name = "$ sd", align = "center",
                          style = function(value) {
                            normalized <- (value - min(hitters_react$dollars_sd, na.rm = TRUE)) / (max(hitters_react$dollars_sd, na.rm = TRUE) - min(hitters_react$dollars_sd, na.rm = TRUE))
                            color <- coloring_opp(normalized)
                            list(background = color)
                          }),
      hr = colDef(name = "HR", align = "center",
                  style = function(value) {
                    normalized <- (value - min(hitters_react$hr)) / (max(hitters_react$hr) - min(hitters_react$hr))
                    color <- coloring(normalized)
                    list(background = color)
                  }),
      r = colDef(name = "Runs", align = "center",
                 style = function(value) {
                   normalized <- (value - min(hitters_react$r)) / (max(hitters_react$r) - min(hitters_react$r))
                   color <- coloring(normalized)
                   list(background = color)
                 }),
      rbi = colDef(name = "RBI", align = "center",
                   style = function(value) {
                     normalized <- (value - min(hitters_react$rbi)) / (max(hitters_react$rbi) - min(hitters_react$rbi))
                     color <- coloring(normalized)
                     list(background = color)
                   }),
      sb = colDef(name = "SB", align = "center",
                  style = function(value) {
                    normalized <- (value - min(hitters_react$sb)) / (max(hitters_react$sb) - min(hitters_react$sb))
                    color <- coloring(normalized)
                    list(background = color)
                  }),
      avg = colDef(name = "Avg", align = "center", format = colFormat(digits = 3),
                   style = function(value) {
                     normalized <- (value - min(hitters_react$avg)) / (max(hitters_react$avg) - min(hitters_react$avg))
                     color <- coloring(normalized)
                     list(background = color)
                   }),
      ab = colDef(name = "AB", align = "center"),
      hr_per600 = colDef(name = "HR Rate", align = "center"),
      r_per600 = colDef(name = "R Rate", align = "center"),
      rbi_per600 = colDef(name = "RBI Rate", align = "center"),
      sb_per600 = colDef(name = "SB Rate", align = "center")
    ),
    defaultColDef = colDef(minWidth = 62, format = colFormat(digits = 0)),
    defaultPageSize = 20,
    fullWidth = FALSE,
    style = list(fontFamily = "Work Sans, sans-serif"),
    details = function(index){
      #risk_data <- CO2[CO2$Plant == data$Plant[index], ]
      risk_data <- hitters_risk[hitters_risk$player_name == hitters_react$player_name[index], ]
      risk_data_1 <- risk_data |> select(c(system, dollars, ab, hr, r, rbi, sb, hr_per600, r_per600, rbi_per600, sb_per600)) |> rename("scenario" = "system")
      htmltools::div(style = "padding: 1rem",
                     reactable(risk_data_1, outlined = TRUE,
                               defaultColDef = colDef(maxWidth = 80, format = colFormat(digits = 0)))
      )
    }
  )
  #output2 <- ifelse(output == "df", hitters_fa, ifelse(output == "table", reactable_hitters, "error"))
  #return(output2)
  reactable_hitters
}



# pitchers

pitchers <- left_join(pitchers_df, pitcher_values |> select(c(playerid, system, dollars)), 
                      by = c("playerid"="playerid", "system" = "system")) |>
  left_join(players |> select(fg_major_league_id, avg_salary, last_10, roster, position_s), 
            by = c("playerid" = "fg_major_league_id")) |>
  rename("position" = "position_s") |>
  mutate(whip = (h+bb) / ip,
         era = (er/ip) * 9,
         k_9 = so / (ip/9),
         bb_9 = bb / (ip/9),
         k_bb = so/bb) |>
  filter(!is.na(dollars))

free_agent_all_pitchers_rds <- pitchers |>
  group_by(position, playerid) |>
  summarize(dollars_avg = mean(dollars, na.rm = TRUE)) |>
  ungroup() |>
  mutate(position_rank = rank(-dollars_avg)) |>
  ungroup() |>
  select(c(playerid, dollars_avg, position, position_rank)) |>
  left_join(pitchers |> select(-c(position)), by = "playerid", relationship = "many-to-many") |>
  mutate(position_rank = paste0(position, position_rank)) |>
  group_by(player_name, playerid, position, position_rank) |>
  summarize(ip = mean(ip),
            w = mean(w),
            er = mean(er),
            h = mean(h),
            bb = mean(bb),
            sv = mean(sv),
            so = mean(so),
            dollars_sd = sd(dollars),
            dollars = mean(dollars_avg)) |>
  ungroup() |>
  mutate(whip = (h+bb) / ip,
         era = (er/ip) * 9,
         k_9 = so / (ip/9),
         bb_9 = bb / (ip/9),
         k_bb = so/bb) |>
  select(c(player_name, position, position_rank, dollars, dollars_sd, w, so, sv, era, whip, ip, k_9, k_bb)) %>%
  head(2000)

free_agent_pitchers_all_reactable <- function(df) {
  #reactable
  pitchers_react <- df |> filter(!is.nan(dollars), era < 5.75) |> arrange(desc(dollars))
  coloring <- function(x) {
    x <- x[!is.na(x)]
    rgb(colorRamp(c("red", "white", "green"))(x), maxColorValue = 255)
  }
  coloring_opp <- function(x) {
    x <- x[!is.na(x)]
    rgb(colorRamp(c("green", "white", "red"))(x), maxColorValue = 255)
  }
  
  #get pitchers
  pitchers <- left_join(pitchers_df, pitcher_values |> select(c(playerid, system, dollars)), 
                        by = c("playerid"="playerid", "system" = "system")) |>
    left_join(players |> select(fg_major_league_id, avg_salary, last_10, roster, position_s), 
              by = c("playerid" = "fg_major_league_id")) |>
    rename("position" = "position_s") |>
    mutate(whip = (h+bb) / ip,
           era = (er/ip) * 9,
           k_9 = so / (ip/9),
           bb_9 = bb / (ip/9),
           k_bb = so/bb) |>
    filter(!is.na(dollars))
  #hitters sub table
  pitchers_risk <- bind_rows(
    pitchers |>
      group_by(player_name, playerid, position) |>
      summarize(across(c(dollars, ip, w, sv, so, era, whip, k_9, bb_9, k_bb), \(x) mean(x, na.rm = TRUE))) |>
      ungroup() |>
      mutate(system = "average"),
    pitchers |>
      group_by(player_name, playerid, position) |>
      summarize(across(c(dollars, ip, w, sv, so, era, whip, k_9, bb_9, k_bb), \(x) sd(x, na.rm = TRUE))) |>
      ungroup() |>
      mutate(system = "sd"),
    pitchers |>
      group_by(player_name, playerid, position) |>
      summarize(across(c(dollars, ip, w, sv, so, era, whip, k_9, bb_9, k_bb), \(x) min(x, na.rm = TRUE))) |>
      ungroup() |>
      mutate(system = "min"),
    pitchers |>
      group_by(player_name, playerid, position) |>
      summarize(across(c(dollars, ip, w, sv, so, era, whip, k_9, bb_9, k_bb), \(x) max(x, na.rm = TRUE))) |>
      ungroup() |>
      mutate(system = "max"),
    pitchers |>
      select(c(player_name, playerid, position, dollars, ip, w, sv, so, era, whip, k_9, bb_9, k_bb, system)))
  
  # Define the table
  reactable_pitchers <- reactable(
    pitchers_react,
    columns = list(
      player_name = colDef(name = "Player", minWidth = 170, filterable = TRUE),
      position = colDef(name = "Position", maxWidth = 80, filterable = TRUE),
      position_rank = colDef(name = "Rank", align = "center"),
      dollars = colDef(name = "$$", align = "center",
                       style = function(value) {
                         normalized <- (value - min(pitchers_react$dollars)) / (max(pitchers_react$dollars) - min(pitchers_react$dollars))
                         color <- coloring(normalized)
                         list(background = color)
                       }),
      dollars_sd = colDef(name = "$ sd", align = "center",
                          style = function(value) {
                            normalized <- (value - min(pitchers_react$dollars_sd, na.rm = TRUE)) / (max(pitchers_react$dollars_sd, na.rm = TRUE) - min(pitchers_react$dollars_sd, na.rm = TRUE))
                            color <- coloring_opp(normalized)
                            list(background = color)
                          }),
      w = colDef(name = "W", align = "center",
                 style = function(value) {
                   normalized <- (value - min(pitchers_react$w)) / (max(pitchers_react$w) - min(pitchers_react$w))
                   color <- coloring(normalized)
                   list(background = color)
                 }),
      so = colDef(name = "K", align = "center",
                  style = function(value) {
                    normalized <- (value - min(pitchers_react$so)) / (max(pitchers_react$so) - min(pitchers_react$so))
                    color <- coloring(normalized)
                    list(background = color)
                  }),
      sv = colDef(name = "SV", align = "center",
                  style = function(value) {
                    normalized <- (value - min(pitchers_react$sv)) / (max(pitchers_react$sv) - min(pitchers_react$sv))
                    color <- coloring(normalized)
                    list(background = color)
                  }),
      era = colDef(name = "ERA", align = "center", format = colFormat(digits = 2),
                   style = function(value) {
                     normalized <- (value - min(pitchers_react$era)) / (max(pitchers_react$era) - min(pitchers_react$era))
                     color <- coloring_opp(normalized)
                     list(background = color)
                   }),
      whip = colDef(name = "WHIP", align = "center", format = colFormat(digits = 2),
                    style = function(value) {
                      normalized <- (value - min(pitchers_react$whip)) / (max(pitchers_react$whip) - min(pitchers_react$whip))
                      color <- coloring_opp(normalized)
                      list(background = color)
                    }),
      ip = colDef(name = "IP", align = "center"),
      k_9 = colDef(name = "K/9", align = "center", format = colFormat(digits = 1)),
      k_bb = colDef(name = "K-BB", align = "center", format = colFormat(digits = 1))
    ),
    defaultColDef = colDef(minWidth = 62, format = colFormat(digits = 0)),
    defaultPageSize = 20,
    fullWidth = TRUE,
    style = list(fontFamily = "Work Sans, sans-serif"),
    details = function(index){
      #risk_data <- CO2[CO2$Plant == data$Plant[index], ]
      risk_data <- pitchers_risk[pitchers_risk$player_name == pitchers_react$player_name[index], ]
      risk_data_1 <- risk_data |> select(c(system, dollars, ip, w, so, sv, era, whip, k_9, k_bb)) |> rename("scenario" = "system")
      htmltools::div(style = "padding: 1rem",
                     reactable(risk_data_1, outlined = TRUE,
                               columns = list(
                                 era = colDef(name = "era", format = colFormat(digits = 2)),
                                 whip = colDef(name = "whip", format = colFormat(digits = 2)),
                                 k_9 = colDef(name = "K/9", format = colFormat(digits = 1)),
                                 k_bb = colDef(name = "K-BB", format = colFormat(digits = 1))
                               ),
                               defaultColDef = colDef(maxWidth = 80, format = colFormat(digits = 0)))
      )
    }
  )
  #output2 <- ifelse(output == "df", hitters_fa, ifelse(output == "table", reactable_hitters, "error"))
  #return(output2)
  reactable_pitchers
}

# dani rojas ---------------------------------------------------------

#dani_rojas_hitters <- free_agent_hitters_rds(1275)
##write_rds(dani_rojas_hitters, file = "ottoneu/dani_rojas_hitters.rds")
#write.csv(dani_rojas_hitters, file = "ottoneu/dani_rojas_hitters.csv")

#dani_rojas_pitchers <- free_agent_pitchers_rds(1275)
#write_rds(dani_rojas_pitchers, file = "ottoneu/dani_rojas_pitchers.rds")
#write.csv(dani_rojas_pitchers, file = "ottoneu/dani_rojas_pitchers.csv")


# bum bum ---------------------------------------------------------

bum_bum_hitters <- free_agent_hitters_rds(1023)
#write_rds(bum_bum_hitters, file = "ottoneu/bum_bum_hitters.rds")
write.csv(bum_bum_hitters, file = "C:/Users/Bobby (Villanova)/OneDrive - Villanova University/Desktop/bum_bum_hitters.csv")

bum_bum_pitchers <- free_agent_pitchers_rds(1023)
#write_rds(bum_bum_pitchers, file = "ottoneu/bum_bum_pitchers.rds")
#write.csv(bum_bum_pitchers, file = "ottoneu/bum_bum_pitchers.csv")
write.csv(bum_bum_pitchers, file = "C:/Users/Bobby (Villanova)/OneDrive - Villanova University/Desktop/bum_bum_pitchers.csv")


# all players -------------------------------------------------------------

#write.csv(free_agent_all_hitters_rds, file = "ottoneu/all_hitters.csv")

#write.csv(free_agent_all_pitchers_rds, file = "ottoneu/all_pitchers.csv")

####### projections

hitters_df2 <- data.frame(system = character(),
                         player_name = character(),
                         playerid = character(),
                         ab = numeric(),
                         h = numeric(),
                         hr = numeric(),
                         r = numeric(),
                         rbi = numeric(),
                         sb = numeric(),
                         bb = numeric())


for (i in projection_systems) {
  hitter_url <- paste0("https://www.fangraphs.com/api/projections?type=", i,"&stats=bat&pos=all&team=0&players=0&lg=all")
  hitters_list <- read_json(hitter_url)
  df <- map_dfr(hitters_list, ~as.data.frame(t(unlist(.)))) |> 
    clean_names() |>
    select(c(player_name, playerid, minpos, team, ab, h, hr, r, rbi, sb, bb)) |>
    mutate_at(c('ab', 'h', 'hr', 'r', 'rbi', 'sb', 'bb'), as.numeric) |>
    mutate(system = i)
  hitters_df2 <- bind_rows(hitters_df2, df)
}

hitters_points <- hitters_df2 %>%
  group_by(player_name) %>%
  summarize(h = mean(h, na.rm = TRUE),
            hr = mean(hr, na.rm = TRUE),
            rbi = mean(rbi, na.rm = TRUE),
            r = mean(r, na.rm = TRUE),
            sb = mean(sb, na.rm = TRUE),
            bb = mean(bb, na.rm = TRUE)) %>%
  ungroup() %>%
  mutate(points = 
           1 * h +
           3 * hr +
           1 * rbi +
           1 * r +
           3 * sb +
           1 * bb
           ) %>%
  arrange(desc(points))

#write.csv(hitters_points,
#          file = "H:/My Drive/R_playground/fantrax_hitters.csv")

##

selected_cols <- c("player_name", "ip", "w", "er", "h", "bb", "sv", "so", "qs")
numeric_cols <- c("ip", "w", "er", "h", "bb", "sv", "so", "qs")

pitchers_df2 <- data.frame()  # Initialize empty data frame


for (i in projection_systems1) {
  pitcher_url <- paste0("https://www.fangraphs.com/api/projections?type=", i, "&stats=pit&pos=all&team=0&players=0&lg=all")
  pitchers_list <- jsonlite::read_json(pitcher_url)
  df <- purrr::map_dfr(pitchers_list, ~as.data.frame(t(unlist(.)))) %>%
    clean_names() %>%
    select(any_of(selected_cols)) %>%
    mutate(system = i) #%>%
    #mutate(across(where(~ !is.character(.) || . == "player_name"), as.character)) %>%
    #mutate(qs = ifelse(ncol(.) == 10, as.numeric(qs), 0))
  
  # Convert all columns to numeric except 'system' and 'player_name'
  num_cols <- setdiff(names(df), c("system", "player_name"))
  df[, num_cols] <- lapply(df[, num_cols], as.numeric)
  
  pitchers_df2 <- dplyr::bind_rows(pitchers_df2, df)
}




pitcher_points <- pitchers_df2 %>%
  mutate(qs = ifelse(system == "zips", NA, qs),
         h_bb = h + bb) %>%
  group_by(player_name) %>%
  summarize(ip = mean(ip, na.rm = TRUE),
    er = mean(er, na.rm = TRUE),
            qs = mean(qs, na.rm = TRUE),
            sv = mean(sv, na.rm = TRUE),
            h_bb = mean(h_bb, na.rm = TRUE),
            so = mean(so, na.rm = TRUE),
            w = mean(w, na.rm = TRUE)) %>%
  ungroup() %>%
  mutate(points = 
           -1.5 * er +
           1.5 * ip +
           3 * qs +
           6 * sv +
           1.5 * so +
           3 * w +
           -.5 * h_bb
  ) %>%
  arrange(desc(points))
  
#write.csv(pitcher_points,
#          file = "H:/My Drive/R_playground/fantrax_pitchers.csv")
